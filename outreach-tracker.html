<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Outreach Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <style>
        :root {
            --core-green: #2d5016;
            --edge-yellow: #d4a574;
            --beyond-red: #8b4513;
            --priority-hot: #c41e3a;
            --priority-medium: #f4a460;
            --priority-low: #6b8e23;
            --bg-primary: #fafaf8;
            --bg-secondary: #f5f5f0;
            --text-primary: #2a2a2a;
            --text-secondary: #666666;
            --border-color: #d4d4cc;
            --card-bg: #ffffff;
            --shadow-subtle: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-medium: 0 4px 12px rgba(0,0,0,0.08);
            --shadow-elevated: 0 8px 24px rgba(0,0,0,0.12);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @import url('https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@300;400;600&family=Work+Sans:wght@300;400;500;600&display=swap');

        body {
            font-family: 'Work Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #fafaf8 0%, #f5f5f0 100%);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .app-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            margin-bottom: 3rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 2rem;
        }

        h1 {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: -0.02em;
            color: var(--core-green);
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 300;
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            letter-spacing: 0.02em;
        }

        .nav-tab:hover {
            color: var(--text-primary);
        }

        .nav-tab.active {
            color: var(--core-green);
            border-bottom-color: var(--core-green);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
        }

        .search-box input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            background: var(--card-bg);
            transition: all 0.2s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: var(--core-green);
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }

        .action-buttons {
            display: flex;
            gap: 0.75rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-primary);
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background: var(--bg-secondary);
            border-color: var(--core-green);
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn-primary {
            background: var(--core-green);
            color: white;
            border-color: var(--core-green);
        }

        .btn-primary:hover {
            background: #234010;
            border-color: #234010;
        }

        .table-container {
            background: var(--card-bg);
            border-radius: 8px;
            overflow: auto;
            box-shadow: var(--shadow-medium);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: var(--bg-secondary);
        }

        th {
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid var(--border-color);
        }

        th:hover {
            background: #ebebde;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        tr:hover {
            background: var(--bg-primary);
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            letter-spacing: 0.02em;
        }

        .priority-hot { background: rgba(196, 30, 58, 0.1); color: var(--priority-hot); }
        .priority-medium { background: rgba(244, 164, 96, 0.1); color: var(--priority-medium); }
        .priority-low { background: rgba(107, 142, 35, 0.1); color: var(--priority-low); }

        .status-invited { background: rgba(212, 165, 116, 0.1); color: var(--edge-yellow); }
        .status-connected { background: rgba(45, 80, 22, 0.1); color: var(--core-green); }
        .status-responded { background: rgba(45, 80, 22, 0.15); color: var(--core-green); font-weight: 600; }
        .status-ignored { background: rgba(139, 69, 19, 0.1); color: var(--beyond-red); }

        .stage-unaware { background: rgba(200, 200, 200, 0.1); color: #666666; }
        .stage-awareness { background: rgba(212, 165, 116, 0.1); color: var(--edge-yellow); }
        .stage-engaged { background: rgba(244, 164, 96, 0.15); color: #d4842f; }
        .stage-consideration { background: rgba(107, 142, 35, 0.1); color: var(--priority-low); }
        .stage-active { background: rgba(45, 80, 22, 0.1); color: var(--core-green); }
        .stage-active-conversation { background: rgba(45, 80, 22, 0.1); color: var(--core-green); }
        .stage-conversion { background: rgba(45, 80, 22, 0.2); color: var(--core-green); font-weight: 600; }

        .row-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-icon {
            padding: 0.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .btn-icon:hover {
            color: var(--core-green);
            transform: scale(1.1);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.2s ease;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--card-bg);
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-elevated);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            padding: 2rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h2 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8rem;
            font-weight: 400;
            color: var(--core-green);
        }

        .modal-body {
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            background: var(--card-bg);
            transition: all 0.2s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--core-green);
            box-shadow: 0 0 0 3px rgba(45, 80, 22, 0.1);
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .communication-log {
            margin-top: 2rem;
        }

        .log-entry {
            background: var(--bg-primary);
            padding: 1rem;
            border-left: 3px solid var(--core-green);
            margin-bottom: 1rem;
            border-radius: 4px;
        }

        .log-entry-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .log-entry-content {
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .chart-card {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: var(--shadow-medium);
        }

        .chart-card h3 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 1.5rem;
            color: var(--core-green);
        }

        .calendar-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .calendar-day:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .calendar-day-number {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .calendar-day-tasks {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .calendar-day.urgent {
            background: rgba(196, 30, 58, 0.05);
            border-color: var(--priority-hot);
        }

        .calendar-day.upcoming {
            background: rgba(244, 164, 96, 0.05);
            border-color: var(--priority-medium);
        }

        .calendar-day.done {
            background: rgba(107, 142, 35, 0.05);
            border-color: var(--priority-low);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-medium);
            border-left: 4px solid var(--core-green);
        }

        .stat-value {
            font-family: 'Crimson Pro', serif;
            font-size: 2.5rem;
            font-weight: 300;
            color: var(--core-green);
            margin-bottom: 0.25rem;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            font-family: 'Crimson Pro', serif;
            font-size: 1.5rem;
            font-weight: 300;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .tag {
            padding: 0.25rem 0.75rem;
            background: var(--bg-secondary);
            border-radius: 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
            
            .table-container {
                overflow-x: auto;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            h1 {
                font-size: 2rem;
            }
        }

        .hidden {
            display: none !important;
        }

        .filter-section {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .filter-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .filter-group select {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
            background: var(--card-bg);
        }

        /* Calendar Month Grid Styles */
        .month-grid-container {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: var(--shadow-medium);
        }

        .month-grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .month-grid-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.3rem;
            color: var(--core-green);
        }

        .month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.25rem;
        }

        .month-grid-day-label {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .month-grid-day {
            aspect-ratio: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            min-height: 50px;
        }

        .month-grid-day:hover {
            background: var(--card-bg);
            box-shadow: var(--shadow-medium);
            transform: translateY(-2px);
        }

        .month-grid-day.other-month {
            opacity: 0.3;
        }

        .month-grid-day.today {
            border: 2px solid var(--core-green);
            background: rgba(45, 80, 22, 0.05);
        }

        .month-grid-day-number {
            font-size: 0.9rem;
            font-weight: 500;
        }

        .month-grid-day-dots {
            display: flex;
            gap: 2px;
            margin-top: 4px;
        }

        .action-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
        }

        .action-dot.hot { background: var(--priority-hot); }
        .action-dot.medium { background: var(--priority-medium); }
        .action-dot.low { background: var(--priority-low); }

        /* Calendar Actions List Styles */
        .calendar-section {
            margin-bottom: 1.5rem;
        }

        .calendar-section-header {
            font-family: 'Crimson Pro', serif;
            font-size: 1.2rem;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .calendar-action-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 1.25rem;
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-subtle);
            transition: all 0.2s ease;
            border-left: 4px solid transparent;
        }

        .calendar-action-card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateX(4px);
        }

        .calendar-action-card.priority-hot { border-left-color: var(--priority-hot); }
        .calendar-action-card.priority-medium { border-left-color: var(--priority-medium); }
        .calendar-action-card.priority-low { border-left-color: var(--priority-low); }

        /* Engagement Heat Map Styles */
        .engagement-summary {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .engagement-metric {
            text-align: center;
        }

        .engagement-metric-value {
            font-family: 'Crimson Pro', serif;
            font-size: 1.8rem;
            font-weight: 600;
            color: var(--core-green);
        }

        .engagement-metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        .engagement-bar {
            height: 8px;
            background: var(--bg-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .engagement-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--priority-low), var(--core-green));
            transition: width 0.3s ease;
        }

        .engagement-icon {
            font-size: 1.2rem;
            margin-right: 0.5rem;
        }

        .communication-timeline {
            margin-top: 1rem;
        }

        .timeline-entry {
            display: flex;
            gap: 1rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .timeline-entry:last-child {
            border-bottom: none;
        }

        .timeline-date {
            flex-shrink: 0;
            width: 80px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-type {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.25rem;
        }

        .timeline-details {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .timeline-expand {
            cursor: pointer;
            color: var(--core-green);
            font-size: 0.85rem;
            margin-top: 0.25rem;
            user-select: none;
        }

        .timeline-expand:hover {
            text-decoration: underline;
        }

        .timeline-expanded-content {
            margin-top: 0.5rem;
            padding: 0.75rem;
            background: var(--bg-primary);
            border-radius: 4px;
            font-size: 0.85rem;
            line-height: 1.6;
        }

        .timeline-actions {
                display: inline-block;
                margin-left: 10px;
                opacity: 0.3;
                transition: opacity 0.2s ease;
            }
            
        .timeline-entry:hover .timeline-actions {
                opacity: 1;
            }

        .engagement-type-high { color: var(--priority-hot); font-weight: 600; }
        .engagement-type-medium { color: var(--priority-medium); font-weight: 500; }
        .engagement-type-low { color: var(--text-secondary); }

        /* Communication Entry Cards */
        .communication-entry-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            position: relative;
        }

        .communication-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .communication-entry-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .btn-remove-entry {
            padding: 0.4rem 0.8rem;
            background: rgba(196, 30, 58, 0.1);
            color: var(--priority-hot);
            border: 1px solid rgba(196, 30, 58, 0.2);
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-remove-entry:hover {
            background: var(--priority-hot);
            color: white;
        }

        .time-input-group {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .time-input-group input[type="time"],
        .time-input-group input[type="date"] {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Work Sans', sans-serif;
            font-size: 0.9rem;
        }

        .communication-burst-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .burst-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>Strategic Outreach Manager</h1>
            <p class="subtitle">High-Touch Relationship Intelligence</p>
            
            <div class="nav-tabs">
                <button class="nav-tab active" data-tab="dashboard">Dashboard</button>
                <button class="nav-tab" data-tab="analytics">Analytics</button>
                <button class="nav-tab" data-tab="calendar">Calendar</button>
                <button class="nav-tab" data-tab="learnings">Learnings</button>
                <button class="nav-tab" data-tab="insights">Insights</button>
                <button class="nav-tab" data-tab="templates">Templates</button>
            </div>
        </header>

        <!-- Dashboard Tab -->
        <div class="tab-content active" id="dashboard">
            <div class="toolbar">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search contacts, companies, or tags...">
                </div>
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="app.openAddContactModal()">+ Add Contact</button>
                    <button class="btn" onclick="app.exportCSV()">‚Üì Export CSV</button>
                    <input type="file" id="csvImport" accept=".csv" style="display: none;" onchange="app.importCSV(event)">
                    <button class="btn" onclick="document.getElementById('csvImport').click()">‚Üë Import CSV</button>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-group">
                    <label>Priority</label>
                    <select id="filterPriority" onchange="app.applyFilters()">
                        <option value="">All Priorities</option>
                        <option value="Hot">Hot</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Funnel Stage</label>
                    <select id="filterStage" onchange="app.applyFilters()">
                        <option value="">All Stages</option>
                        <option value="Unaware">Unaware</option>
                        <option value="Awareness">Awareness</option>
                        <option value="Engaged">Engaged</option>
                        <option value="Consideration">Consideration</option>
                        <option value="Active Conversation">Active Conversation</option>
                        <option value="Conversion">Conversion</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Connection Status</label>
                    <select id="filterStatus" onchange="app.applyFilters()">
                        <option value="">All Statuses</option>
                        <option value="Invited">Invited</option>
                        <option value="Connected">Connected</option>
                        <option value="Responded">Responded</option>
                        <option value="Ignored">Ignored</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Industry Focus</label>
                    <select id="filterIndustry" onchange="app.applyFilters()">
                        <option value="">All Industries</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
                <div class="filter-group">
                    <label>Tags</label>
                    <select id="filterTags" onchange="app.applyFilters()">
                        <option value="">All Tags</option>
                        <!-- Populated dynamically -->
                    </select>
                </div>
            </div>

            <!-- Bulk Actions Bar -->
            <div id="bulkActionsBar" class="hidden" style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong><span id="selectedCount">0</span> selected</strong>
                </div>
                <div style="display: flex; gap: 0.75rem;">
                    <select id="bulkActionSelect" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-family: 'Work Sans', sans-serif;">
                        <option value="">Choose Action...</option>
                        <option value="priority">Change Priority</option>
                        <option value="stage">Change Stage</option>
                        <option value="status">Change Status</option>
                        <option value="delete">Delete Selected</option>
                    </select>
                    <button class="btn btn-primary" onclick="app.executeBulkAction()">Apply</button>
                    <button class="btn" onclick="app.clearSelection()">Clear Selection</button>
                </div>
            </div>

            <div class="table-container">
                <table id="contactsTable">
                    <thead>
                        <tr>
                            <th style="width: 50px;">
                                <input type="checkbox" id="selectAll" onchange="app.toggleSelectAll()" aria-label="Select all contacts">
                            </th>
                            <th onclick="app.sortTable('company')">Company</th>
                            <th onclick="app.sortTable('name')">Name</th>
                            <th onclick="app.sortTable('jobTitle')">Job Title</th>
                            <th onclick="app.sortTable('industryFocus')">Industry</th>
                            <th onclick="app.sortTable('country')">Country</th>
                            <th onclick="app.sortTable('tier')">Tier</th>
                            <th onclick="app.sortTable('connectionMethod')">Method</th>
                            <th onclick="app.sortTable('connectionStatus')">Status</th>
                            <th onclick="app.sortTable('priority')">Priority</th>
                            <th onclick="app.sortTable('funnelStage')">Stage</th>
                            <th onclick="app.sortTable('nextActionDate')">Next Action</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="contactsTableBody">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Tab -->
        <div class="tab-content" id="analytics">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalContacts">0</div>
                    <div class="stat-label">Total Contacts</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeOutreach">0</div>
                    <div class="stat-label">Active Outreach</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="responseRate">0%</div>
                    <div class="stat-label">Response Rate</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="conversions">0</div>
                    <div class="stat-label">Conversions</div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Funnel Overview</h3>
                    <canvas id="funnelChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Channel Effectiveness</h3>
                    <canvas id="channelChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Tier Distribution</h3>
                    <canvas id="tierChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Priority Distribution</h3>
                    <canvas id="priorityChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Calendar Tab -->
        <div class="tab-content" id="calendar">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.8rem; font-weight: 400; color: var(--core-green); margin: 0;">Upcoming Actions</h2>
                
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <label style="font-size: 0.9rem; color: var(--text-secondary);">Jump to:</label>
                        <input type="date" id="calendarJumpDate" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-family: 'Work Sans', sans-serif;">
                        <button class="btn" onclick="app.jumpToDate()">Go</button>
                        <button class="btn" onclick="app.jumpToToday()">Today</button>
                    </div>
                    
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <label style="font-size: 0.9rem; color: var(--text-secondary);">View:</label>
                        <select id="calendarViewRange" onchange="app.updateCalendarView()" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 4px; font-family: 'Work Sans', sans-serif;">
                            <option value="7">7 days</option>
                            <option value="30" selected>30 days</option>
                            <option value="90">90 days</option>
                        </select>
                    </div>
                    
                    <label style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); cursor: pointer;">
                        <input type="checkbox" id="showOverdue" onchange="app.updateCalendarView()" checked>
                        Show overdue
                    </label>
                </div>
            </div>

            <!-- Month Grid Overview -->
            <div id="calendarMonthGrid" style="margin-bottom: 2rem;">
                <!-- Populated by JS -->
            </div>

            <!-- Upcoming Actions List -->
            <div id="calendarActionsList">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Learnings Tab -->
        <div class="tab-content" id="learnings">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 1rem;">
                <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.8rem; font-weight: 400; color: var(--core-green); margin: 0;">Account Learnings</h2>
                <button class="btn btn-primary" onclick="app.openWeeklyLearningPrompt()">+ Log This Week's Learnings</button>
            </div>

            <!-- Weekly Goals Card -->
            <div id="weeklyGoalsCard" style="margin-bottom: 2rem;">
                <!-- Populated by JS -->
            </div>
            
            <!-- Monthly Goals Card -->
            <div id="monthlyGoalsCard" style="margin-bottom: 2rem;">
                <!-- Populated by JS -->
            </div>

            <!-- This Week Section -->
            <div id="thisWeekLearnings" style="margin-bottom: 2rem;">
                <!-- Populated by JS -->
            </div>

            <!-- Pattern Detection -->
            <div id="patternDetection" style="margin-bottom: 2rem;">
                <!-- Populated by JS -->
            </div>

            <!-- Past Learnings Archive -->
            <div>
                <h3 style="font-family: 'Crimson Pro', serif; font-size: 1.4rem; font-weight: 400; margin-bottom: 1.5rem; color: var(--core-green);">Past Learnings</h3>
                
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="learningSearchInput" placeholder="Search learnings by company, signal, or insights..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; font-family: 'Work Sans', sans-serif;">
                </div>

                <div id="">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Insights Tab -->
        <div class="tab-content" id="insights">
            <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.8rem; font-weight: 400; margin-bottom: 2rem; color: var(--core-green);">Strategic Insights</h2>
            <div id="insightsContainer">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Templates Tab -->
        <div class="tab-content" id="templates">
            <h2 style="font-family: 'Crimson Pro', serif; font-size: 1.8rem; font-weight: 400; margin-bottom: 2rem; color: var(--core-green);">Message Templates</h2>
            <div class="toolbar">
                <div class="action-buttons">
                    <button class="btn btn-primary" onclick="app.openAddTemplateModal()">+ Add Template</button>
                </div>
            </div>
            <div id="templatesContainer">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Add/Edit Contact Modal -->
    <div class="modal" id="contactModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Add Contact</h2>
            </div>
            
                <form id="contactForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Company *</label>
                            <input type="text" id="company" required>
                        </div>
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="contactName" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Job Title / Position</label>
                            <input type="text" id="jobTitle" placeholder="e.g., CEO, Chief Innovation Officer, Board Advisor">
                        </div>
                        <div class="form-group">
                            <label>Role / Tier *</label>
                            <select id="tier" required>
                                <option value="">Select Tier</option>
                                <option value="Decision-maker">Decision-maker</option>
                                <option value="Introducer">Introducer</option>
                                <option value="Influencer">Influencer</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Industry Focus</label>
                            <input type="text" id="industryFocus" placeholder="e.g., Luxury, Tech, Finance, Industrial">
                        </div>
                        <div class="form-group">
                            <label>Country / Region</label>
                            <input type="text" id="country" placeholder="e.g., France, USA, Singapore">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Connection Method *</label>
                            <select id="connectionMethod" required onchange="app.toggleOtherMethod()">
                                <option value="">Select Method</option>
                                <option value="LinkedIn">LinkedIn</option>
                                <option value="Email">Email</option>
                                <option value="WhatsApp">WhatsApp</option>
                                <option value="Personal Intro">Personal Intro</option>
                                <option value="Old Contact">Old Contact</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Connection Status *</label>
                            <select id="connectionStatus" required>
                                <option value="">Select Status</option>
                                <option value="Invited">Invited</option>
                                <option value="Connected">Connected</option>
                                <option value="Responded">Responded</option>
                                <option value="Ignored">Ignored</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group hidden" id="otherMethodGroup">
                        <label>Specify Other Method</label>
                        <input type="text" id="otherMethod" placeholder="e.g., Conference, Cold call, Referral">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Priority *</label>
                            <select id="priority" required>
                                <option value="">Select Priority</option>
                                <option value="Hot">Hot</option>
                                <option value="Medium">Medium</option>
                                <option value="Low">Low</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Opportunity Type *</label>
                            <select id="opportunityType" required>
                                <option value="">Select Type</option>
                                <option value="Strategic fit">Strategic fit</option>
                                <option value="Product interest">Product interest</option>
                                <option value="Future potential">Future potential</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Funnel Stage *</label>
                            <select id="funnelStage" required>
                                <option value="">Select Stage</option>
                                <option value="Unaware">Unaware (Pre-funnel)</option>
                                <option value="Awareness">Awareness</option>
                                <option value="Engaged">Engaged</option>
                                <option value="Consideration">Consideration</option>
                                <option value="Active Conversation">Active Conversation</option>
                                <option value="Conversion">Conversion</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Next Action Date</label>
                            <input type="date" id="nextActionDate">
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Tags (comma-separated)</label>
                        <input type="text" id="tags" placeholder="e.g., Portfolio innovation, Tech-ready, Luxury">
                    </div>

                    <div class="form-group">
                        <label>Notes / Insights</label>
                        <textarea id="notes" placeholder="Key insights, objections, or context..."></textarea>
                    </div>

                    <input type="hidden" id="contactId">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="app.closeModal('contactModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveContact()">Save Contact</button>
            </div>
        </div>
    </div>

    <!-- Communication Log Modal -->
    <div class="modal" id="logModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>Communication Log</h2>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Add one or multiple communications from this interaction</p>
            </div>
            <div class="modal-body">
                <div id="communicationEntries">
                    <!-- Dynamically populated with communication entry forms -->
                </div>

                <button class="btn" onclick="app.addCommunicationEntry()" style="width: 100%; margin-top: 1rem; border-style: dashed;">
                    + Add Another Communication
                </button>

                <div class="communication-log" id="existingLogs" style="margin-top: 2rem;">
                    <!-- Populated by JS -->
                </div>

                <input type="hidden" id="logContactId">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="app.closeModal('logModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveAllLogs()">
                    <span id="saveLogButtonText">Save Communication</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Learning Log Modal -->
    <div class="modal" id="learningModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>Account Learning</h2>
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">Week of <span id="learningWeekLabel"></span></p>
            </div>
            <div class="modal-body">
                <form id="learningForm">
                    <!-- Company header -->
                    <div style="background: var(--bg-primary); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h3 style="font-size: 1.3rem; margin-bottom: 1rem; color: var(--core-green);" id="learningCompanyName"></h3>
                        
                        <div style="margin-bottom: 0.5rem;">
                            <strong>This Week's Activity:</strong>
                        </div>
                        <div id="weekActivitySimple" style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.8;">
                            <!-- Auto-populated -->
                        </div>
                    </div>
            
                    <!-- Company-level takeaway -->
                    <div class="form-group">
                        <label>Company-Level Takeaway</label>
                        <textarea id="learningTakeaway" placeholder="Overall learning about this company (2-3 sentences)" rows="4" required></textarea>
                    </div>
            
                    <!-- Per-person assessments -->
                    <div style="border-top: 2px solid var(--border-color); padding-top: 1.5rem; margin-top: 1.5rem;">
                        <h4 style="margin-bottom: 1rem; color: var(--core-green);">Individual Assessments</h4>
                        <div id="personAssessments">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
            
                    <!-- Deep Dive Mode toggle -->
                    <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                        <button type="button" class="btn" onclick="app.toggleDeepDiveMode()" style="font-size: 0.9rem;">
                            üîç Switch to Deep Dive Mode ‚Üí
                        </button>
                    </div>
            
                    <!-- Deep Dive Mode (hidden by default) -->
                    <div id="deepDiveModeFields" class="hidden">
                        <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1.5rem; font-style: italic;">
                            Use this for quarterly reviews or when you need detailed strategic analysis
                        </p>
            
                        <div class="form-group">
                            <label>Strategic Thesis</label>
                            <textarea id="learningThesis" placeholder="Why this company matters" rows="3"></textarea>
                        </div>
            
                        <div class="form-row">
                            <div class="form-group">
                                <label>P&L Ownership</label>
                                <input type="text" id="learningPL" placeholder="e.g., CFO, Business Unit Head">
                            </div>
                            <div class="form-group">
                                <label>Innovation Ownership</label>
                                <input type="text" id="learningInnovation" placeholder="e.g., CTO, Separate lab">
                            </div>
                        </div>
            
                        <div class="form-group">
                            <label>Decision-Making Process</label>
                            <textarea id="learningDecisions" placeholder="How decisions get made" rows="2"></textarea>
                        </div>
            
                        <div class="form-group">
                            <label>Evidence for Signal Strength</label>
                            <textarea id="learningEvidence" placeholder="Why you picked these signal strengths" rows="2"></textarea>
                        </div>
            
                        <div class="form-group">
                            <label>Positioning Insight</label>
                            <textarea id="learningPositioning" placeholder="What's working? What's not?" rows="3"></textarea>
                        </div>
            
                        <div style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
                            <button type="button" class="btn" onclick="app.toggleDeepDiveMode()" style="font-size: 0.9rem;">
                                ‚Üê Switch to Simple Mode
                            </button>
                        </div>
                    </div>
            
                    <input type="hidden" id="learningId">
                    <input type="hidden" id="learningWeekStart">
                    <input type="hidden" id="learningCompany">
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="app.closeModal('learningModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveLearning()">Save Learning</button>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div class="modal" id="templateModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Message Template</h2>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Template Name</label>
                    <input type="text" id="templateName" placeholder="e.g., Tier 1 First Contact">
                </div>

                <div class="form-group">
                    <label>Template Category</label>
                    <select id="templateCategory">
                        <option value="Tier 1">Tier 1 (Decision-maker)</option>
                        <option value="Tier 2">Tier 2 (Introducer)</option>
                        <option value="Tier 3">Tier 3 (Influencer)</option>
                        <option value="Follow-up">Follow-up</option>
                        <option value="Re-engagement">Re-engagement</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Template Style</label>
                    <select id="templateStyle">
                        <option value="Short">Short</option>
                        <option value="Data-heavy">Data-heavy</option>
                        <option value="Insight-heavy">Insight-heavy</option>
                        <option value="Casual">Casual</option>
                        <option value="Formal">Formal</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Template Content</label>
                    <textarea id="templateContent" placeholder="Dear {Name},

{Your message here}

Best regards,
{Your name}" style="min-height: 200px;"></textarea>
                </div>

                <input type="hidden" id="templateId">
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="app.closeModal('templateModal')">Cancel</button>
                <button class="btn btn-primary" onclick="app.saveTemplate()">Save Template</button>
            </div>
        </div>
    </div>

    <script>
        // UUID Generator (RFC4122 v4 compliant)
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // Date normalization and validation
        function normalizeDate(dateStr) {
            if (!dateStr) return null;
            
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) {
                console.warn(`Invalid date: ${dateStr}`);
                return null;
            }
            
            // Return ISO format date string (YYYY-MM-DD)
            return date.toISOString().split('T')[0];
        }

        // Engagement type weighting
        function getEngagementWeight(engagementType) {
            const weights = {
                // High-touch
                'Face-to-face meeting': 10,
                'Lunch/Dinner': 10,
                'Event together': 10,
                'Office visit': 10,
                // Medium-touch
                'Video call': 5,
                'Phone call': 5,
                'Voice message': 4,
                // Low-touch
                'Email exchange': 1,
                'LinkedIn message': 1,
                'WhatsApp text': 1,
                'Text message': 1
            };
            return weights[engagementType] || 1;
        }

        // Calculate total engagement score for a contact
        function calculateEngagementScore(contact) {
            if (!contact.communicationLog || contact.communicationLog.length === 0) return 0;
            
            return contact.communicationLog.reduce((total, log) => {
                return total + getEngagementWeight(log.engagementType || 'Email exchange');
            }, 0);
        }

        // Count high-touch interactions
        function countHighTouchInteractions(contact) {
            if (!contact.communicationLog) return 0;
            
            const highTouchTypes = ['Face-to-face meeting', 'Lunch/Dinner', 'Event together', 'Office visit'];
            return contact.communicationLog.filter(log => 
                highTouchTypes.includes(log.engagementType)
            ).length;
        }

        // Get engagement level (0-10 scale)
        function getEngagementLevel(contact) {
            const score = calculateEngagementScore(contact);
            const logCount = contact.communicationLog ? contact.communicationLog.length : 0;
            
            if (logCount === 0) return 0;
            
            // Normalize to 0-10 scale (assumes max realistic score is 100)
            return Math.min(10, Math.round((score / 10)));
        }

        // Get last high-touch date
        function getLastHighTouchDate(contact) {
            if (!contact.communicationLog) return null;
            
            const highTouchTypes = ['Face-to-face meeting', 'Lunch/Dinner', 'Event together', 'Office visit'];
            const highTouchLogs = contact.communicationLog
                .filter(log => highTouchTypes.includes(log.engagementType))
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return highTouchLogs.length > 0 ? new Date(highTouchLogs[0].date) : null;
        }

        // Auto-upgrade priority based on engagement
        function autoUpgradePriority(contact) {
            const highTouchCount = countHighTouchInteractions(contact);
            
            // 2+ face-to-face meetings ‚Üí upgrade to Hot
            if (highTouchCount >= 2 && contact.priority !== 'Hot') {
                contact.priority = 'Hot';
                return true;
            }
            
            // 1 face-to-face and 5+ total communications ‚Üí upgrade to Medium
            if (highTouchCount >= 1 && contact.communicationLog.length >= 5 && contact.priority === 'Low') {
                contact.priority = 'Medium';
                return true;
            }
            
            return false;
        }

        const app = {
            contacts: [],
            templates: [],
            learnings: [],
            weeklyGoalsHistory: [],
            monthlyGoalsHistory: [],
            monthlyGoals: {
                goal1: { label: 'New Contacts Added', target: 30, current: 0 },
                goal2: { label: 'Meaningful Conversations', target: 6, current: 0 },
                goal3: { label: 'Content/Deliverables', target: 2, current: 0 },
                goal4: { label: 'Proof Assets', target: 1, current: 0 },
                goal5: { label: 'Strategic Partnerships', target: 1, current: 0 }
            },
            weeklyGoals: {
                currentWeek: null,
                goal1: { label: 'New Contacts', target: 8, current: 0 },
                goal2: { label: 'Meaningful Conversations', target: 2, current: 0 },
                goal3: { label: 'Content Pieces', target: 1, current: 0 },
                goal4: { label: 'Proof Assets', target: 0, current: 0 },
                goal5: { label: 'Partnership Discussions', target: 0, current: 0 }
            },
            currentSort: { field: 'company', ascending: true },
            filters: { priority: '', stage: '', status: '', industry: '', tags: [] },
            charts: {},
            searchTimeout: null,
            selectedContacts: new Set(),
            calendarStartDate: new Date(),
            calendarViewDays: 30,
            communicationEntryCount: 0,

            init() {
                this.loadData();
                this.setupEventListeners();
                this.renderContacts();
                this.renderCharts();
                this.renderInsights();
                this.renderTemplates();
                this.renderCalendar();
                this.updateStats();
            },

             loadData() {
                const savedContacts = localStorage.getItem('outreach_contacts');
                const savedTemplates = localStorage.getItem('outreach_templates');
                const savedLearnings = localStorage.getItem('outreach_learnings');
                const savedGoals = localStorage.getItem('outreach_monthly_goals');
                
                if (savedContacts) {
                    this.contacts = JSON.parse(savedContacts);
                }
                
                if (savedTemplates) {
                    this.templates = JSON.parse(savedTemplates);
                } else {
                    // Add default templates with UUID
                    this.templates = [
                        {
                            id: generateUUID(),
                            name: 'Tier 1 - Initial Outreach',
                            category: 'Tier 1',
                            style: 'Formal',
                            content: `Dear {Name},
            
            I hope this message finds you well. I've been following {Company}'s remarkable work in transforming the luxury/tech landscape, and I believe there's an interesting strategic alignment worth exploring.
            
            Would you be open to a brief conversation about how we might collaborate on {specific opportunity}?
            
            Best regards,
            {Your Name}`
                        },
                        {
                            id: generateUUID(),
                            name: 'Follow-up - No Response',
                            category: 'Follow-up',
                            style: 'Short',
                            content: `Hi {Name},
            
            Following up on my previous message regarding {topic}. I understand your schedule is demanding‚Äîwould a brief 15-minute call work better?
            
            Looking forward to connecting.
            
            Best,
            {Your Name}`
                        }
                    ];
                    this.saveData();
                }
            
                if (savedGoals) {
                    this.monthlyGoals = JSON.parse(savedGoals);
                }
                
                const savedWeeklyGoals = localStorage.getItem('outreach_weekly_goals');
                if (savedWeeklyGoals) {
                    this.weeklyGoals = JSON.parse(savedWeeklyGoals);
                }

                const savedWeeklyHistory = localStorage.getItem('outreach_weekly_goals_history');
                if (savedWeeklyHistory) {
                    this.weeklyGoalsHistory = JSON.parse(savedWeeklyHistory);
                }
                
                const savedMonthlyHistory = localStorage.getItem('outreach_monthly_goals_history');
                if (savedMonthlyHistory) {
                    this.monthlyGoalsHistory = JSON.parse(savedMonthlyHistory);
                }
                
                // REPLACE the learnings initialization
                if (savedLearnings) {
                    this.learnings = JSON.parse(savedLearnings);
                } else {
                    this.learnings = []; // Simple array, no default template
                }
                
                // Check if it's a new week and reset if needed
                this.checkAndResetWeeklyGoals();
                
                // Calculate current progress for monthly goals
                this.updateMonthlyGoalsProgress();
            },  // <-- ADD THIS CLOSING BRACE AND COMMA
            
            saveData() {
                localStorage.setItem('outreach_contacts', JSON.stringify(this.contacts));
                localStorage.setItem('outreach_templates', JSON.stringify(this.templates));
                localStorage.setItem('outreach_learnings', JSON.stringify(this.learnings));
                localStorage.setItem('outreach_monthly_goals', JSON.stringify(this.monthlyGoals));
                localStorage.setItem('outreach_weekly_goals', JSON.stringify(this.weeklyGoals));
                localStorage.setItem('outreach_weekly_goals_history', JSON.stringify(this.weeklyGoalsHistory));
                localStorage.setItem('outreach_monthly_goals_history', JSON.stringify(this.monthlyGoalsHistory));
            },

            checkAndResetWeeklyGoals() {
                const weekStart = this.getWeekStart();
                const weekStartStr = weekStart.toISOString().split('T')[0];
                
                if (this.weeklyGoals.currentWeek !== weekStartStr) {
                // Archive the old week before resetting
                if (this.weeklyGoals.currentWeek) {
                    const archived = {
                        weekStart: this.weeklyGoals.currentWeek,
                        goals: JSON.parse(JSON.stringify(this.weeklyGoals)), // Deep copy
                        archivedAt: new Date().toISOString()
                    };
                    this.weeklyGoalsHistory.unshift(archived); // Add to beginning
                    
                    // Keep only last 12 weeks
                    if (this.weeklyGoalsHistory.length > 12) {
                        this.weeklyGoalsHistory = this.weeklyGoalsHistory.slice(0, 12);
                    }
                }
                
                // Reset weekly goals for new week
                this.weeklyGoals.currentWeek = weekStartStr;
                this.weeklyGoals.goal1.current = 0;
                this.weeklyGoals.goal2.current = 0;
                this.weeklyGoals.goal3.current = 0;
                this.weeklyGoals.goal4.current = 0;
                this.weeklyGoals.goal5.current = 0;
                this.weeklyGoals.insight = '';
                this.saveData();
            }
            },

            setupEventListeners() {
                // Tab navigation
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                        
                        e.target.classList.add('active');
                        document.getElementById(e.target.dataset.tab).classList.add('active');
                        
                        if (e.target.dataset.tab === 'analytics') {
                            this.renderCharts();
                        } else if (e.target.dataset.tab === 'calendar') {
                            this.renderCalendar();
                        } else if (e.target.dataset.tab === 'learnings') {
                            this.renderLearnings();
                        } else if (e.target.dataset.tab === 'insights') {
                            this.renderInsights();
                        }
                    });
                });

                // Debounced search (300ms delay)
                document.getElementById('searchInput').addEventListener('input', (e) => {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        this.renderContacts(e.target.value);
                    }, 300);
                });

                // Close modals on background click
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.closeModal(modal.id);
                        }
                    });
                });

                // Populate tag filter
                this.populateTagFilter();
                this.populateIndustryFilter();

                // Set up Friday 5 PM learning reminder
                this.setupFridayReminder();

                // Learning search with debounce
                const learningSearchInput = document.getElementById('learningSearchInput');
                if (learningSearchInput) {
                    learningSearchInput.addEventListener('input', (e) => {
                        clearTimeout(this.searchTimeout);
                        this.searchTimeout = setTimeout(() => {
                            this.render(e.target.value);
                        }, 300);
                    });
                }
            },

            toggleOtherMethod() {
                const methodSelect = document.getElementById('connectionMethod');
                const otherGroup = document.getElementById('otherMethodGroup');
                
                if (methodSelect.value === 'Other') {
                    otherGroup.classList.remove('hidden');
                } else {
                    otherGroup.classList.add('hidden');
                }
            },

            populateTagFilter() {
                const allTags = new Set();
                this.contacts.forEach(contact => {
                    if (contact.tags && Array.isArray(contact.tags)) {
                        contact.tags.forEach(tag => allTags.add(tag));
                    }
                });

                const tagFilter = document.getElementById('filterTags');
                const currentValue = tagFilter.value;
                
                tagFilter.innerHTML = '<option value="">All Tags</option>' +
                    Array.from(allTags).sort().map(tag => 
                        `<option value="${tag}">${tag}</option>`
                    ).join('');
                
                if (currentValue && allTags.has(currentValue)) {
                    tagFilter.value = currentValue;
                }
            },

            populateIndustryFilter() {
                const allIndustries = new Set();
                this.contacts.forEach(contact => {
                    if (contact.industryFocus) {
                        allIndustries.add(contact.industryFocus);
                    }
                });

                const industryFilter = document.getElementById('filterIndustry');
                const currentValue = industryFilter.value;
                
                industryFilter.innerHTML = '<option value="">All Industries</option>' +
                    Array.from(allIndustries).sort().map(industry => 
                        `<option value="${industry}">${industry}</option>`
                    ).join('');
                
                if (currentValue && allIndustries.has(currentValue)) {
                    industryFilter.value = currentValue;
                }
            },

            renderContacts(searchTerm = '') {
                let filteredContacts = this.contacts;

                // Apply search
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredContacts = filteredContacts.filter(c => 
                        c.company.toLowerCase().includes(term) ||
                        c.name.toLowerCase().includes(term) ||
                        (c.industryFocus && c.industryFocus.toLowerCase().includes(term)) ||
                        (c.tags && c.tags.some(tag => tag.toLowerCase().includes(term)))
                    );
                }

                // Apply filters
                if (this.filters.priority) {
                    filteredContacts = filteredContacts.filter(c => c.priority === this.filters.priority);
                }
                if (this.filters.stage) {
                    filteredContacts = filteredContacts.filter(c => c.funnelStage === this.filters.stage);
                }
                if (this.filters.status) {
                    filteredContacts = filteredContacts.filter(c => c.connectionStatus === this.filters.status);
                }
                if (this.filters.industry) {
                    filteredContacts = filteredContacts.filter(c => c.industryFocus === this.filters.industry);
                }
                if (this.filters.tags && this.filters.tags.length > 0) {
                    filteredContacts = filteredContacts.filter(c => 
                        c.tags && c.tags.some(tag => this.filters.tags.includes(tag))
                    );
                }

                // Apply sorting
                filteredContacts.sort((a, b) => {
                    let aVal = a[this.currentSort.field] || '';
                    let bVal = b[this.currentSort.field] || '';
                    
                    if (this.currentSort.field === 'nextActionDate') {
                        aVal = new Date(aVal || '2099-12-31');
                        bVal = new Date(bVal || '2099-12-31');
                    }
                    
                    if (aVal < bVal) return this.currentSort.ascending ? -1 : 1;
                    if (aVal > bVal) return this.currentSort.ascending ? 1 : -1;
                    return 0;
                });

                const tbody = document.getElementById('contactsTableBody');
                
                if (filteredContacts.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="13" style="text-align: center; padding: 3rem;">
                                <div class="empty-state">
                                    <h3>No contacts found</h3>
                                    <p>Start by adding your first contact</p>
                                </div>
                            </td>
                        </tr>
                    `;
                    return;
                }

                tbody.innerHTML = filteredContacts.map(contact => `
                    <tr>
                        <td>
                            <input type="checkbox" 
                                   class="contact-checkbox" 
                                   data-id="${contact.id}"
                                   ${this.selectedContacts.has(contact.id) ? 'checked' : ''}
                                   onchange="app.toggleContactSelection('${contact.id}')"
                                   aria-label="Select ${contact.name}">
                        </td>
                        <td><strong>${contact.company}</strong></td>
                        <td>${contact.name}</td>
                        <td style="color: var(--text-secondary); font-size: 0.85rem;">${contact.jobTitle || '‚Äî'}</td>
                        <td>${contact.industryFocus || '‚Äî'}</td>
                        <td>${contact.country || '‚Äî'}</td>
                        <td>${contact.tier}</td>
                        <td>${contact.connectionMethod}</td>
                        <td><span class="badge status-${contact.connectionStatus.toLowerCase()}">${contact.connectionStatus}</span></td>
                        <td><span class="badge priority-${contact.priority.toLowerCase()}">${contact.priority}</span></td>
                        <td><span class="badge stage-${contact.funnelStage.toLowerCase().replace(/ /g, '-')}">${contact.funnelStage}</span></td>
                        <td>${contact.nextActionDate ? new Date(contact.nextActionDate).toLocaleDateString() : '‚Äî'}</td>
                        <td>
                            <div class="row-actions">
                                <button class="btn-icon" 
                                        onclick="app.openLogModal('${contact.id}')" 
                                        title="Add Communication"
                                        aria-label="Add communication log for ${contact.name}">üìù</button>
                                <button class="btn-icon" 
                                        onclick="app.editContact('${contact.id}')" 
                                        title="Edit"
                                        aria-label="Edit ${contact.name}">‚úèÔ∏è</button>
                                <button class="btn-icon" 
                                        onclick="app.deleteContact('${contact.id}')" 
                                        title="Delete"
                                        aria-label="Delete ${contact.name}">üóëÔ∏è</button>
                            </div>
                        </td>
                    </tr>
                `).join('');

                this.updateStats();
                this.updateBulkActionsBar();
            },

            sortTable(field) {
                if (this.currentSort.field === field) {
                    this.currentSort.ascending = !this.currentSort.ascending;
                } else {
                    this.currentSort.field = field;
                    this.currentSort.ascending = true;
                }
                this.renderContacts(document.getElementById('searchInput').value);
            },

            applyFilters() {
                this.filters.priority = document.getElementById('filterPriority').value;
                this.filters.stage = document.getElementById('filterStage').value;
                this.filters.status = document.getElementById('filterStatus').value;
                this.filters.industry = document.getElementById('filterIndustry').value;
                const selectedTag = document.getElementById('filterTags').value;
                this.filters.tags = selectedTag ? [selectedTag] : [];
                this.renderContacts(document.getElementById('searchInput').value);
            },

            toggleSelectAll() {
                const selectAll = document.getElementById('selectAll');
                const checkboxes = document.querySelectorAll('.contact-checkbox');
                
                if (selectAll.checked) {
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = true;
                        this.selectedContacts.add(checkbox.dataset.id);
                    });
                } else {
                    checkboxes.forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    this.selectedContacts.clear();
                }
                
                this.updateBulkActionsBar();
            },

            toggleContactSelection(id) {
                if (this.selectedContacts.has(id)) {
                    this.selectedContacts.delete(id);
                } else {
                    this.selectedContacts.add(id);
                }
                
                // Update "select all" checkbox state
                const totalCheckboxes = document.querySelectorAll('.contact-checkbox').length;
                const selectAll = document.getElementById('selectAll');
                selectAll.checked = this.selectedContacts.size === totalCheckboxes;
                selectAll.indeterminate = this.selectedContacts.size > 0 && this.selectedContacts.size < totalCheckboxes;
                
                this.updateBulkActionsBar();
            },

            updateBulkActionsBar() {
                const bar = document.getElementById('bulkActionsBar');
                const count = document.getElementById('selectedCount');
                
                if (this.selectedContacts.size > 0) {
                    bar.classList.remove('hidden');
                    count.textContent = this.selectedContacts.size;
                } else {
                    bar.classList.add('hidden');
                }
            },

            clearSelection() {
                this.selectedContacts.clear();
                document.querySelectorAll('.contact-checkbox').forEach(cb => cb.checked = false);
                document.getElementById('selectAll').checked = false;
                this.updateBulkActionsBar();
            },

            async executeBulkAction() {
                const action = document.getElementById('bulkActionSelect').value;
                
                if (!action) {
                    alert('Please select an action');
                    return;
                }
                
                if (this.selectedContacts.size === 0) {
                    alert('Please select at least one contact');
                    return;
                }

                const selectedIds = Array.from(this.selectedContacts);

                if (action === 'delete') {
                    if (!confirm(`Delete ${selectedIds.length} contact(s)?`)) return;
                    
                    this.contacts = this.contacts.filter(c => !selectedIds.includes(c.id));
                    this.selectedContacts.clear();
                    this.saveData();
                    this.renderContacts();
                    return;
                }

                // For other actions, prompt for new value
                let newValue;
                
                if (action === 'priority') {
                    newValue = prompt('Enter new priority (Hot/Medium/Low):');
                    if (!['Hot', 'Medium', 'Low'].includes(newValue)) {
                        alert('Invalid priority. Must be Hot, Medium, or Low');
                        return;
                    }
                } else if (action === 'stage') {
                    newValue = prompt('Enter new stage (Unaware/Awareness/Engaged/Consideration/Active Conversation/Conversion):');
                    if (!['Unaware', 'Awareness', 'Engaged', 'Consideration', 'Active Conversation', 'Conversion'].includes(newValue)) {
                        alert('Invalid stage');
                        return;
                    }
                } else if (action === 'status') {
                    newValue = prompt('Enter new status (Invited/Connected/Responded/Ignored):');
                    if (!['Invited', 'Connected', 'Responded', 'Ignored'].includes(newValue)) {
                        alert('Invalid status');
                        return;
                    }
                }

                // Apply the change
                selectedIds.forEach(id => {
                    const contact = this.contacts.find(c => c.id === id);
                    if (contact) {
                        if (action === 'priority') contact.priority = newValue;
                        else if (action === 'stage') contact.funnelStage = newValue;
                        else if (action === 'status') contact.connectionStatus = newValue;
                    }
                });

                this.selectedContacts.clear();
                this.saveData();
                this.renderContacts();
                alert(`Updated ${selectedIds.length} contact(s)`);
            },

            openAddContactModal() {
                document.getElementById('modalTitle').textContent = 'Add Contact';
                document.getElementById('contactForm').reset();
                document.getElementById('contactId').value = '';
                this.openModal('contactModal');
            },

            editContact(id) {
                const contact = this.contacts.find(c => c.id === id);
                if (!contact) return;

                document.getElementById('modalTitle').textContent = 'Edit Contact';
                document.getElementById('company').value = contact.company;
                document.getElementById('contactName').value = contact.name;
                document.getElementById('jobTitle').value = contact.jobTitle || '';
                document.getElementById('industryFocus').value = contact.industryFocus || '';
                document.getElementById('country').value = contact.country || '';
                document.getElementById('tier').value = contact.tier;
                
                // Handle connection method - check if it's a custom "Other" value
                const standardMethods = ['LinkedIn', 'Email', 'WhatsApp', 'Personal Intro', 'Old Contact'];
                if (standardMethods.includes(contact.connectionMethod)) {
                    document.getElementById('connectionMethod').value = contact.connectionMethod;
                    document.getElementById('otherMethodGroup').classList.add('hidden');
                } else {
                    document.getElementById('connectionMethod').value = 'Other';
                    document.getElementById('otherMethod').value = contact.connectionMethod;
                    document.getElementById('otherMethodGroup').classList.remove('hidden');
                }
                
                document.getElementById('connectionStatus').value = contact.connectionStatus;
                document.getElementById('priority').value = contact.priority;
                document.getElementById('opportunityType').value = contact.opportunityType;
                document.getElementById('funnelStage').value = contact.funnelStage;
                document.getElementById('nextActionDate').value = contact.nextActionDate || '';
                document.getElementById('tags').value = contact.tags ? contact.tags.join(', ') : '';
                document.getElementById('notes').value = contact.notes || '';
                document.getElementById('contactId').value = contact.id;

                this.openModal('contactModal');
            },

            saveContact() {
                const id = document.getElementById('contactId').value;
                const nextActionDateRaw = document.getElementById('nextActionDate').value;
                
                // Handle connection method - use custom text if "Other" is selected
                let connectionMethod = document.getElementById('connectionMethod').value;
                if (connectionMethod === 'Other') {
                    connectionMethod = document.getElementById('otherMethod').value || 'Other';
                }
                
                const contactData = {
                    company: document.getElementById('company').value,
                    name: document.getElementById('contactName').value,
                    jobTitle: document.getElementById('jobTitle').value,
                    industryFocus: document.getElementById('industryFocus').value,
                    country: document.getElementById('country').value,
                    tier: document.getElementById('tier').value,
                    connectionMethod: connectionMethod,
                    connectionStatus: document.getElementById('connectionStatus').value,
                    priority: document.getElementById('priority').value,
                    opportunityType: document.getElementById('opportunityType').value,
                    funnelStage: document.getElementById('funnelStage').value,
                    nextActionDate: normalizeDate(nextActionDateRaw),
                    tags: document.getElementById('tags').value.split(',').map(t => t.trim()).filter(t => t),
                    notes: document.getElementById('notes').value,
                };

                if (id) {
                    // Edit existing
                    const index = this.contacts.findIndex(c => c.id === id);
                    this.contacts[index] = { ...this.contacts[index], ...contactData };
                } else {
                    // Add new with UUID
                    contactData.id = generateUUID();
                    contactData.communicationLog = [];
                    contactData.lastMessage = '';
                    contactData.createdAt = new Date().toISOString(); // ADD THIS LINE
                    this.contacts.push(contactData);
                }

                this.saveData();
                this.populateTagFilter();
                this.populateIndustryFilter();
                this.renderContacts();
                this.renderCalendar(); // Fix: Update calendar when contact dates change
                this.closeModal('contactModal');
            },

            deleteContact(id) {
                if (confirm('Are you sure you want to delete this contact?')) {
                    this.contacts = this.contacts.filter(c => c.id !== id);
                    this.saveData();
                    this.renderContacts();
                }
            },

            openLogModal(contactId) {
                const contact = this.contacts.find(c => c.id === contactId);
                if (!contact) return;

                document.getElementById('logContactId').value = contactId;
                
                // Reset entry counter and create first entry
                this.communicationEntryCount = 0;
                document.getElementById('communicationEntries').innerHTML = '';
                this.addCommunicationEntry(contact.connectionMethod);
                
                this.updateSaveButtonText();

                // Show existing logs with engagement summary
                const logsContainer = document.getElementById('existingLogs');
                
                if (contact.communicationLog && contact.communicationLog.length > 0) {
                    const engagementScore = calculateEngagementScore(contact);
                    const engagementLevel = getEngagementLevel(contact);
                    const lastHighTouch = getLastHighTouchDate(contact);
                    const totalTouchpoints = contact.communicationLog.length;
                    const highTouchCount = countHighTouchInteractions(contact);
                    
                    const lastHighTouchText = lastHighTouch 
                        ? `${Math.floor((new Date() - lastHighTouch) / (1000 * 60 * 60 * 24))} days ago`
                        : 'Never';
                    
                    const getEngagementIcon = (type) => {
                        if (['Face-to-face meeting', 'Lunch/Dinner', 'Event together', 'Office visit'].includes(type)) return 'ü§ù';
                        if (['Video call', 'Phone call', 'Voice message'].includes(type)) return 'üìπ';
                        return 'üìß';
                    };

                    // Group communications by date to show bursts
                    const groupedByDate = {};
                    contact.communicationLog.forEach(log => {
                        const dateKey = new Date(log.date).toLocaleDateString();
                        if (!groupedByDate[dateKey]) {
                            groupedByDate[dateKey] = [];
                        }
                        groupedByDate[dateKey].push(log);
                    });

                    logsContainer.innerHTML = `
                        <h4 style="margin-bottom: 1rem; font-family: Crimson Pro, serif; color: var(--core-green);">Communication Timeline</h4>
                        
                        <div class="engagement-summary">
                            <div class="engagement-metric">
                                <div class="engagement-metric-value">${engagementLevel}/10</div>
                                <div class="engagement-metric-label">Engagement</div>
                                <div class="engagement-bar">
                                    <div class="engagement-bar-fill" style="width: ${engagementLevel * 10}%"></div>
                                </div>
                            </div>
                            <div class="engagement-metric">
                                <div class="engagement-metric-value">${lastHighTouchText}</div>
                                <div class="engagement-metric-label">Last High-Touch</div>
                            </div>
                            <div class="engagement-metric">
                                <div class="engagement-metric-value">${totalTouchpoints}</div>
                                <div class="engagement-metric-label">Total Touchpoints</div>
                            </div>
                            <div class="engagement-metric">
                                <div class="engagement-metric-value">${highTouchCount}</div>
                                <div class="engagement-metric-label">Face-to-Face</div>
                            </div>
                        </div>
                        
                        <div class="communication-timeline">
                            ${Object.keys(groupedByDate).map(dateKey => {
                                const logs = groupedByDate[dateKey];
                                const showBurst = logs.length > 1;
                                
                                return logs.map((log, idx) => {
                                    const weight = getEngagementWeight(log.engagementType || 'Email exchange');
                                    const engagementClass = weight >= 10 ? 'engagement-type-high' : 
                                                           weight >= 5 ? 'engagement-type-medium' : 
                                                           'engagement-type-low';
                                    const icon = getEngagementIcon(log.engagementType);
                                    const logTime = new Date(log.date);
                                    const timeStr = logTime.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                                    
                                    return `
                                        <div class="timeline-entry">
                                            <div class="timeline-date">
                                                ${idx === 0 ? dateKey : ''}
                                                ${showBurst && idx === 0 ? `<div class="communication-burst-indicator"><span class="burst-dot"></span><span class="burst-dot"></span><span class="burst-dot"></span> ${logs.length} interactions</div>` : ''}
                                            </div>
                                            <div class="timeline-content">
                                                <div class="timeline-type ${engagementClass}">
                                                    ${icon} ${log.engagementType || 'Email exchange'}
                                                    ${timeStr !== 'Invalid Date' ? ` ‚Ä¢ ${timeStr}` : ''}
                                                    ${log.duration ? ` ‚Ä¢ ${log.duration}` : ''}
                                                    ${log.location ? ` ‚Ä¢ ${log.location}` : ''}
                                                        <!-- ADD EDIT/DELETE BUTTONS HERE -->
                                                    <div class="timeline-actions" style="display: inline-block; margin-left: 10px;">
                                                        <button class="btn-icon" onclick="app.editCommunicationLog('${contactId}', ${contact.communicationLog.indexOf(log)})" style="font-size: 0.75rem; padding: 2px 5px;">‚úèÔ∏è Edit</button>
                                                        <button class="btn-icon" onclick="app.deleteCommunicationLog('${contactId}', ${contact.communicationLog.indexOf(log)})" style="font-size: 0.75rem; padding: 2px 5px; color: var(--priority-hot);">üóëÔ∏è Delete</button>
                                                    </div>
                                                </div>
                                            
                                                <div class="timeline-details">
                                                    ${log.message.length > 80 ? log.message.substring(0, 80) + '...' : log.message}
                                                </div>
                                                ${log.message.length > 80 || log.response ? `
                                                    <div class="timeline-expand" onclick="this.nextElementSibling.classList.toggle('hidden')">
                                                        View details ‚ñº
                                                    </div>
                                                    <div class="timeline-expanded-content hidden">
                                                        <strong>Message:</strong> ${log.message}<br>
                                                        ${log.response ? `<strong>Response:</strong> ${log.response}<br>` : ''}
                                                        ${log.sentiment ? `<strong>Sentiment:</strong> <span class="badge">${log.sentiment}</span>` : ''}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `;
                                }).join('');
                            }).join('')}
                        </div>
                    `;
                } else {
                    logsContainer.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No previous communications logged.</p>';
                }

                this.openModal('logModal');
            },

            addCommunicationEntry(defaultChannel = 'Email') {
                this.communicationEntryCount++;
                const entryId = this.communicationEntryCount;
                const container = document.getElementById('communicationEntries');
                
                // Get current date and time for auto-fill
                const now = new Date();
                const currentDate = now.toISOString().split('T')[0];
                const currentTime = now.toTimeString().slice(0, 5);

                const entryHTML = `
                    <div class="communication-entry-card" id="entry-${entryId}">
                        <div class="communication-entry-header">
                            <div class="communication-entry-title">Communication ${entryId}</div>
                            <button class="btn-remove-entry" onclick="app.removeCommunicationEntry(${entryId})" ${entryId === 1 ? 'style="display: none;"' : ''}>
                                ‚úï Remove
                            </button>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Date & Time</label>
                                <div class="time-input-group">
                                    <input type="date" id="entryDate-${entryId}" value="${currentDate}">
                                    <input type="time" id="entryTime-${entryId}" value="${currentTime}">
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Channel</label>
                                <select id="entryChannel-${entryId}">
                                    <option value="LinkedIn" ${defaultChannel === 'LinkedIn' ? 'selected' : ''}>LinkedIn</option>
                                    <option value="Email" ${defaultChannel === 'Email' ? 'selected' : ''}>Email</option>
                                    <option value="WhatsApp" ${defaultChannel === 'WhatsApp' ? 'selected' : ''}>WhatsApp</option>
                                    <option value="Phone" ${defaultChannel === 'Phone' ? 'selected' : ''}>Phone</option>
                                    <option value="In-person" ${defaultChannel === 'In-person' ? 'selected' : ''}>In-person</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Engagement Type</label>
                            <select id="entryEngagementType-${entryId}">
                                <optgroup label="High-Touch">
                                    <option value="Face-to-face meeting">Face-to-face meeting</option>
                                    <option value="Lunch/Dinner">Lunch/Dinner</option>
                                    <option value="Event together">Event together</option>
                                    <option value="Office visit">Office visit</option>
                                </optgroup>
                                <optgroup label="Medium-Touch">
                                    <option value="Video call">Video call</option>
                                    <option value="Phone call">Phone call</option>
                                    <option value="Voice message">Voice message</option>
                                </optgroup>
                                <optgroup label="Low-Touch">
                                    <option value="Email exchange" selected>Email exchange</option>
                                    <option value="LinkedIn message">LinkedIn message</option>
                                    <option value="WhatsApp text">WhatsApp text</option>
                                    <option value="Text message">Text message</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Duration (optional)</label>
                                <input type="text" id="entryDuration-${entryId}" placeholder="e.g., 45 mins, 2 hours">
                            </div>

                            <div class="form-group">
                                <label>Location (optional)</label>
                                <input type="text" id="entryLocation-${entryId}" placeholder="e.g., Paris office, Zoom, Phone">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Message / Notes</label>
                            <textarea id="entryMessage-${entryId}" placeholder="What did you discuss or communicate?" rows="3"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Response Received (optional)</label>
                            <textarea id="entryResponse-${entryId}" placeholder="How did they respond?" rows="2"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Sentiment / Insight</label>
                            <select id="entrySentiment-${entryId}">
                                <option value="">Select sentiment...</option>
                                <option value="Very positive">Very positive</option>
                                <option value="Positive">Positive</option>
                                <option value="Neutral">Neutral</option>
                                <option value="Needs follow-up">Needs follow-up</option>
                                <option value="Not interested">Not interested</option>
                            </select>
                        </div>
                    </div>
                `;

                container.insertAdjacentHTML('beforeend', entryHTML);
                this.updateSaveButtonText();
            },

            removeCommunicationEntry(entryId) {
                const entryElement = document.getElementById(`entry-${entryId}`);
                if (entryElement) {
                    entryElement.remove();
                    this.updateSaveButtonText();
                }
            },

            updateSaveButtonText() {
                const entryCount = document.querySelectorAll('.communication-entry-card').length;
                const buttonText = document.getElementById('saveLogButtonText');
                buttonText.textContent = entryCount === 1 
                    ? 'Save Communication' 
                    : `Save All (${entryCount} communications)`;
            },

            saveAllLogs() {
                const contactId = document.getElementById('logContactId').value;
                const contact = this.contacts.find(c => c.id === contactId);
                
                if (!contact) return;

                const entries = document.querySelectorAll('.communication-entry-card');
                const logEntries = [];

                entries.forEach((entry, index) => {
                    const entryId = entry.id.split('-')[1];
                    
                    const date = document.getElementById(`entryDate-${entryId}`).value;
                    const time = document.getElementById(`entryTime-${entryId}`).value;
                    const datetime = new Date(`${date}T${time}`);

                    const logEntry = {
                        date: datetime.toISOString(),
                        channel: document.getElementById(`entryChannel-${entryId}`).value,
                        engagementType: document.getElementById(`entryEngagementType-${entryId}`).value,
                        duration: document.getElementById(`entryDuration-${entryId}`).value,
                        location: document.getElementById(`entryLocation-${entryId}`).value,
                        message: document.getElementById(`entryMessage-${entryId}`).value,
                        response: document.getElementById(`entryResponse-${entryId}`).value,
                        sentiment: document.getElementById(`entrySentiment-${entryId}`).value
                    };

                    // Only add if message is not empty
                    if (logEntry.message.trim()) {
                        logEntries.push(logEntry);
                    }
                });

                if (logEntries.length === 0) {
                    alert('Please add at least one communication with a message.');
                    return;
                }

                if (!contact.communicationLog) {
                    contact.communicationLog = [];
                }
                
                // Add all entries (they'll be sorted by date in the display)
                logEntries.forEach(entry => {
                    contact.communicationLog.unshift(entry);
                });

                // Sort communication log by date (most recent first)
                contact.communicationLog.sort((a, b) => new Date(b.date) - new Date(a.date));

                // Update last message to most recent
                contact.lastMessage = logEntries[0].message.substring(0, 100);

                // Auto-upgrade priority based on engagement
                const upgraded = autoUpgradePriority(contact);
                
                this.saveData();
                this.renderContacts();
                this.closeModal('logModal');
                
                if (upgraded) {
                    alert(`üéâ Priority automatically upgraded to ${contact.priority} due to high engagement!`);
                } else if (logEntries.length > 1) {
                    alert(`‚úÖ ${logEntries.length} communications logged successfully!`);
                }
            },

            editCommunicationLog(contactId, logIndex) {
                const contact = this.contacts.find(c => c.id === contactId);
                if (!contact || !contact.communicationLog || !contact.communicationLog[logIndex]) return;
                
                const log = contact.communicationLog[logIndex];
                
                // Clear any existing form and create a pre-filled edit form
                this.communicationEntryCount = 0;
                document.getElementById('communicationEntries').innerHTML = '';
                
                // Convert date to proper format
                const logDate = new Date(log.date);
                const dateStr = logDate.toISOString().split('T')[0];
                const timeStr = logDate.toTimeString().slice(0, 5);
                
                const entryHTML = `
                    <div class="communication-entry-card" id="edit-form">
                        <div class="communication-entry-header">
                            <div class="communication-entry-title">‚úèÔ∏è Edit Communication</div>
                            <button class="btn-remove-entry" onclick="app.cancelEditCommunication()">
                                ‚úï Cancel Edit
                            </button>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label>Date & Time</label>
                                <div class="time-input-group">
                                    <input type="date" id="entryDate-edit" value="${dateStr}">
                                    <input type="time" id="entryTime-edit" value="${timeStr}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Channel</label>
                                <select id="entryChannel-edit">
                                    <option value="LinkedIn" ${log.channel === 'LinkedIn' ? 'selected' : ''}>LinkedIn</option>
                                    <option value="Email" ${log.channel === 'Email' ? 'selected' : ''}>Email</option>
                                    <option value="WhatsApp" ${log.channel === 'WhatsApp' ? 'selected' : ''}>WhatsApp</option>
                                    <option value="Phone" ${log.channel === 'Phone' ? 'selected' : ''}>Phone</option>
                                    <option value="In-person" ${log.channel === 'In-person' ? 'selected' : ''}>In-person</option>
                                    <option value="Other" ${!['LinkedIn', 'Email', 'WhatsApp', 'Phone', 'In-person'].includes(log.channel) ? 'selected' : ''}>Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Engagement Type</label>
                            <select id="entryEngagementType-edit">
                                <optgroup label="High-Touch">
                                    <option value="Face-to-face meeting" ${log.engagementType === 'Face-to-face meeting' ? 'selected' : ''}>Face-to-face meeting</option>
                                    <option value="Lunch/Dinner" ${log.engagementType === 'Lunch/Dinner' ? 'selected' : ''}>Lunch/Dinner</option>
                                    <option value="Event together" ${log.engagementType === 'Event together' ? 'selected' : ''}>Event together</option>
                                    <option value="Office visit" ${log.engagementType === 'Office visit' ? 'selected' : ''}>Office visit</option>
                                </optgroup>
                                <optgroup label="Medium-Touch">
                                    <option value="Video call" ${log.engagementType === 'Video call' ? 'selected' : ''}>Video call</option>
                                    <option value="Phone call" ${log.engagementType === 'Phone call' ? 'selected' : ''}>Phone call</option>
                                    <option value="Voice message" ${log.engagementType === 'Voice message' ? 'selected' : ''}>Voice message</option>
                                </optgroup>
                                <optgroup label="Low-Touch">
                                    <option value="Email exchange" ${log.engagementType === 'Email exchange' ? 'selected' : ''}>Email exchange</option>
                                    <option value="LinkedIn message" ${log.engagementType === 'LinkedIn message' ? 'selected' : ''}>LinkedIn message</option>
                                    <option value="WhatsApp text" ${log.engagementType === 'WhatsApp text' ? 'selected' : ''}>WhatsApp text</option>
                                    <option value="Text message" ${log.engagementType === 'Text message' ? 'selected' : ''}>Text message</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Duration (optional)</label>
                                <input type="text" id="entryDuration-edit" value="${log.duration || ''}" placeholder="e.g., 45 mins, 2 hours">
                            </div>
                            <div class="form-group">
                                <label>Location (optional)</label>
                                <input type="text" id="entryLocation-edit" value="${log.location || ''}" placeholder="e.g., Paris office, Zoom, Phone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Message / Notes</label>
                            <textarea id="entryMessage-edit" placeholder="What did you discuss or communicate?" rows="3">${log.message || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Response Received (optional)</label>
                            <textarea id="entryResponse-edit" placeholder="How did they respond?" rows="2">${log.response || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Sentiment / Insight</label>
                            <select id="entrySentiment-edit">
                                <option value="">Select sentiment...</option>
                                <option value="Very positive" ${log.sentiment === 'Very positive' ? 'selected' : ''}>Very positive</option>
                                <option value="Positive" ${log.sentiment === 'Positive' ? 'selected' : ''}>Positive</option>
                                <option value="Neutral" ${log.sentiment === 'Neutral' ? 'selected' : ''}>Neutral</option>
                                <option value="Needs follow-up" ${log.sentiment === 'Needs follow-up' ? 'selected' : ''}>Needs follow-up</option>
                                <option value="Not interested" ${log.sentiment === 'Not interested' ? 'selected' : ''}>Not interested</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary" onclick="app.saveEditedCommunication('${contactId}', ${logIndex})" style="width: 100%;">
                                üíæ Save Changes
                            </button>
                        </div>
                    </div>
                `;
                
                document.getElementById('communicationEntries').innerHTML = entryHTML;
                
                // Update the save button text
                document.getElementById('saveLogButtonText').textContent = 'Editing Communication';
                
                // Scroll to the form
                document.querySelector('.modal-content').scrollTop = 0;
            },

            cancelEditCommunication() {
                // Reset to normal log entry form
                this.communicationEntryCount = 0;
                document.getElementById('communicationEntries').innerHTML = '';
                this.addCommunicationEntry();
                this.updateSaveButtonText();
            },

            saveEditedCommunication(contactId, logIndex) {
                const contact = this.contacts.find(c => c.id === contactId);
                if (!contact || !contact.communicationLog) return;
                
                const date = document.getElementById('entryDate-edit').value;
                const time = document.getElementById('entryTime-edit').value;
                const datetime = new Date(`${date}T${time}`);
                
                if (isNaN(datetime.getTime())) {
                    alert('Please enter a valid date and time');
                    return;
                }
                
                const updatedLog = {
                    date: datetime.toISOString(),
                    channel: document.getElementById('entryChannel-edit').value,
                    engagementType: document.getElementById('entryEngagementType-edit').value,
                    duration: document.getElementById('entryDuration-edit').value,
                    location: document.getElementById('entryLocation-edit').value,
                    message: document.getElementById('entryMessage-edit').value,
                    response: document.getElementById('entryResponse-edit').value,
                    sentiment: document.getElementById('entrySentiment-edit').value
                };
                
                if (!updatedLog.message.trim()) {
                    alert('Message cannot be empty');
                    return;
                }
                
                // Update the log entry
                contact.communicationLog[logIndex] = updatedLog;
                
                // Sort communication log by date (most recent first)
                contact.communicationLog.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Update last message
                contact.lastMessage = contact.communicationLog[0].message.substring(0, 100);
                
                this.saveData();
                
                // Refresh the log modal to show updated entry
                this.openLogModal(contactId);
                
                alert('‚úÖ Communication updated successfully!');
            },

            deleteCommunicationLog(contactId, logIndex) {
                if (!confirm('Are you sure you want to delete this communication log?')) {
                    return;
                }
                
                const contact = this.contacts.find(c => c.id === contactId);
                if (!contact || !contact.communicationLog || !contact.communicationLog[logIndex]) return;
                
                // Remove the log entry
                contact.communicationLog.splice(logIndex, 1);
                
                // Update last message if there are still logs
                if (contact.communicationLog.length > 0) {
                    contact.lastMessage = contact.communicationLog[0].message.substring(0, 100);
                } else {
                    contact.lastMessage = '';
                }
                
                this.saveData();
                
                // Refresh the log modal
                this.openLogModal(contactId);
                
                alert('üóëÔ∏è Communication log deleted!');
            },
            
            openAddTemplateModal() {
                document.getElementById('templateName').value = '';
                document.getElementById('templateCategory').value = 'Tier 1';
                document.getElementById('templateStyle').value = 'Formal';
                document.getElementById('templateContent').value = '';
                document.getElementById('templateId').value = '';
                this.openModal('templateModal');
            },

            saveTemplate() {
                const id = document.getElementById('templateId').value;
                const templateData = {
                    name: document.getElementById('templateName').value,
                    category: document.getElementById('templateCategory').value,
                    style: document.getElementById('templateStyle').value,
                    content: document.getElementById('templateContent').value
                };

                if (id) {
                    const index = this.templates.findIndex(t => t.id === id);
                    this.templates[index] = { ...this.templates[index], ...templateData };
                } else {
                    templateData.id = generateUUID();
                    this.templates.push(templateData);
                }

                this.saveData();
                this.renderTemplates();
                this.closeModal('templateModal');
            },

            renderTemplates() {
                const container = document.getElementById('templatesContainer');
                
                if (this.templates.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No templates yet</h3><p>Create your first message template</p></div>';
                    return;
                }

                container.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                        ${this.templates.map(template => `
                            <div class="chart-card">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                    <div>
                                        <h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">${template.name}</h3>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <span class="badge">${template.category}</span>
                                            <span class="badge">${template.style}</span>
                                        </div>
                                    </div>
                                    <button class="btn-icon" 
                                            onclick="app.deleteTemplate('${template.id}')"
                                            aria-label="Delete template ${template.name}">üóëÔ∏è</button>
                                </div>
                                <pre style="white-space: pre-wrap; font-family: 'Work Sans', sans-serif; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; background: var(--bg-primary); padding: 1rem; border-radius: 4px; max-height: 200px; overflow-y: auto;">${template.content}</pre>
                                <button class="btn" 
                                        style="width: 100%; margin-top: 1rem;" 
                                        onclick="app.copyTemplate('${template.id}')"
                                        aria-label="Copy template ${template.name}">Copy Template</button>
                            </div>
                        `).join('')}
                    </div>
                `;
            },

            copyTemplate(id) {
                const template = this.templates.find(t => t.id === id);
                if (!template) return;

                navigator.clipboard.writeText(template.content).then(() => {
                    alert('Template copied to clipboard!');
                });
            },

            deleteTemplate(id) {
                if (confirm('Delete this template?')) {
                    this.templates = this.templates.filter(t => t.id !== id);
                    this.saveData();
                    this.renderTemplates();
                }
            },

            jumpToToday() {
                this.calendarStartDate = new Date();
                document.getElementById('calendarJumpDate').value = '';
                this.updateCalendarView();
            },

            jumpToDate() {
                const dateInput = document.getElementById('calendarJumpDate').value;
                if (dateInput) {
                    this.calendarStartDate = new Date(dateInput);
                    this.updateCalendarView();
                }
            },

            updateCalendarView() {
                this.calendarViewDays = parseInt(document.getElementById('calendarViewRange').value);
                this.renderCalendar();
            },

            renderCalendar() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const showOverdue = document.getElementById('showOverdue').checked;
                const viewDays = this.calendarViewDays;
                const startDate = new Date(this.calendarStartDate);
                startDate.setHours(0, 0, 0, 0);
                
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + viewDays);

                // Get all contacts with action dates
                let actionContacts = this.contacts
                    .filter(c => c.nextActionDate)
                    .map(c => ({
                        ...c,
                        dateObj: new Date(c.nextActionDate)
                    }));

                // Filter based on overdue setting
                if (!showOverdue) {
                    actionContacts = actionContacts.filter(c => c.dateObj >= today);
                }

                // Render month grid
                this.renderMonthGrid(actionContacts, startDate);

                // Render actions list
                this.renderActionsList(actionContacts, startDate, endDate, today);
            },

            renderMonthGrid(actionContacts, viewStartDate) {
                const container = document.getElementById('calendarMonthGrid');
                
                // Get the month to display (first day of the month containing viewStartDate)
                const displayMonth = new Date(viewStartDate.getFullYear(), viewStartDate.getMonth(), 1);
                const monthName = displayMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                
                // Count actions in this month
                const actionsThisMonth = actionContacts.filter(c => {
                    return c.dateObj.getMonth() === displayMonth.getMonth() && 
                           c.dateObj.getFullYear() === displayMonth.getFullYear();
                }).length;

                // Calculate grid days
                const firstDay = displayMonth.getDay(); // 0 = Sunday
                const daysInMonth = new Date(displayMonth.getFullYear(), displayMonth.getMonth() + 1, 0).getDate();
                const prevMonthDays = new Date(displayMonth.getFullYear(), displayMonth.getMonth(), 0).getDate();
                
                // Build grid
                let gridHTML = `
                    <div class="month-grid-container">
                        <div class="month-grid-header">
                            <div class="month-grid-title">${monthName}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">${actionsThisMonth} action${actionsThisMonth !== 1 ? 's' : ''} this month</div>
                        </div>
                        <div class="month-grid">
                `;

                // Day labels
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                    gridHTML += `<div class="month-grid-day-label">${day}</div>`;
                });

                // Previous month days
                for (let i = firstDay - 1; i >= 0; i--) {
                    const dayNum = prevMonthDays - i;
                    gridHTML += `<div class="month-grid-day other-month"><span class="month-grid-day-number">${dayNum}</span></div>`;
                }

                // Current month days
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                for (let day = 1; day <= daysInMonth; day++) {
                    const currentDate = new Date(displayMonth.getFullYear(), displayMonth.getMonth(), day);
                    const isToday = currentDate.getTime() === today.getTime();
                    
                    // Find actions on this day
                    const dayActions = actionContacts.filter(c => {
                        return c.dateObj.getDate() === day && 
                               c.dateObj.getMonth() === displayMonth.getMonth() &&
                               c.dateObj.getFullYear() === displayMonth.getFullYear();
                    });

                    // Group by priority
                    const priorityCounts = { Hot: 0, Medium: 0, Low: 0 };
                    dayActions.forEach(c => priorityCounts[c.priority]++);

                    const dots = [];
                    if (priorityCounts.Hot > 0) {
                        for (let i = 0; i < Math.min(priorityCounts.Hot, 3); i++) {
                            dots.push('<div class="action-dot hot"></div>');
                        }
                    }
                    if (priorityCounts.Medium > 0 && dots.length < 3) {
                        for (let i = 0; i < Math.min(priorityCounts.Medium, 3 - dots.length); i++) {
                            dots.push('<div class="action-dot medium"></div>');
                        }
                    }
                    if (priorityCounts.Low > 0 && dots.length < 3) {
                        for (let i = 0; i < Math.min(priorityCounts.Low, 3 - dots.length); i++) {
                            dots.push('<div class="action-dot low"></div>');
                        }
                    }

                    gridHTML += `
                        <div class="month-grid-day ${isToday ? 'today' : ''}" 
                             onclick="app.jumpToSpecificDate('${currentDate.toISOString().split('T')[0]}')">
                            <span class="month-grid-day-number">${day}</span>
                            ${dots.length > 0 ? `<div class="month-grid-day-dots">${dots.join('')}</div>` : ''}
                        </div>
                    `;
                }

                // Next month days to fill grid
                const totalCells = firstDay + daysInMonth;
                const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
                for (let i = 1; i <= remainingCells; i++) {
                    gridHTML += `<div class="month-grid-day other-month"><span class="month-grid-day-number">${i}</span></div>`;
                }

                gridHTML += `</div></div>`;
                container.innerHTML = gridHTML;
            },

            jumpToSpecificDate(dateStr) {
                document.getElementById('calendarJumpDate').value = dateStr;
                this.jumpToDate();
            },

            renderActionsList(actionContacts, startDate, endDate, today) {
                const container = document.getElementById('calendarActionsList');
                
                // Filter contacts within view range
                const viewContacts = actionContacts
                    .filter(c => c.dateObj >= startDate && c.dateObj < endDate)
                    .sort((a, b) => a.dateObj - b.dateObj);

                if (viewContacts.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h3>No actions scheduled</h3>
                            <p>No contacts have action dates in this time period</p>
                        </div>
                    `;
                    return;
                }

                // Group by date
                const groupedByDate = {};
                viewContacts.forEach(contact => {
                    const dateKey = contact.dateObj.toISOString().split('T')[0];
                    if (!groupedByDate[dateKey]) {
                        groupedByDate[dateKey] = [];
                    }
                    groupedByDate[dateKey].push(contact);
                });

                // Build HTML
                let html = '';
                Object.keys(groupedByDate).sort().forEach(dateKey => {
                    const date = new Date(dateKey);
                    const contacts = groupedByDate[dateKey];
                    const daysFromNow = Math.floor((date - today) / (1000 * 60 * 60 * 24));
                    
                    let sectionLabel;
                    if (daysFromNow < 0) {
                        sectionLabel = `OVERDUE (${Math.abs(daysFromNow)} day${Math.abs(daysFromNow) !== 1 ? 's' : ''} ago)`;
                    } else if (daysFromNow === 0) {
                        sectionLabel = 'TODAY';
                    } else if (daysFromNow === 1) {
                        sectionLabel = 'TOMORROW';
                    } else if (daysFromNow <= 7) {
                        sectionLabel = date.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                    } else {
                        sectionLabel = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
                    }

                    html += `
                        <div class="calendar-section">
                            <div class="calendar-section-header">${sectionLabel}</div>
                            ${contacts.map(contact => {
                                const engagementScore = calculateEngagementScore(contact);
                                const highTouchCount = countHighTouchInteractions(contact);
                                
                                return `
                                    <div class="calendar-action-card priority-${contact.priority.toLowerCase()}">
                                        <div style="display: flex; justify-content: space-between; align-items: start; gap: 1rem;">
                                            <div style="flex: 1;">
                                                <h3 style="font-size: 1.1rem; margin-bottom: 0.25rem; color: var(--text-primary);">
                                                    ${contact.company}
                                                </h3>
                                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.75rem;">
                                                    ${contact.name}${contact.jobTitle ? ` ‚Ä¢ ${contact.jobTitle}` : ''} ‚Ä¢ ${contact.tier}
                                                    ${contact.industryFocus ? ` ‚Ä¢ ${contact.industryFocus}` : ''}
                                                    ${contact.country ? ` ‚Ä¢ ${contact.country}` : ''}
                                                </p>
                                                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                                                    <span class="badge priority-${contact.priority.toLowerCase()}">${contact.priority}</span>
                                                    <span class="badge stage-${contact.funnelStage.toLowerCase().replace(/ /g, '-')}">${contact.funnelStage}</span>
                                                    ${highTouchCount > 0 ? `<span class="badge" style="background: rgba(45, 80, 22, 0.1); color: var(--core-green);">ü§ù ${highTouchCount} face-to-face</span>` : ''}
                                                    ${engagementScore > 20 ? `<span class="badge" style="background: rgba(45, 80, 22, 0.1); color: var(--core-green);">High engagement</span>` : ''}
                                                </div>
                                                ${contact.notes ? `
                                                    <p style="font-size: 0.85rem; color: var(--text-secondary); font-style: italic; margin-top: 0.5rem;">
                                                        ${contact.notes.substring(0, 120)}${contact.notes.length > 120 ? '...' : ''}
                                                    </p>
                                                ` : ''}
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn-icon" 
                                                        onclick="app.openLogModal('${contact.id}')"
                                                        aria-label="Add communication">üìù</button>
                                                <button class="btn-icon" 
                                                        onclick="app.editContact('${contact.id}')"
                                                        aria-label="Edit contact">‚úèÔ∏è</button>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                });

                container.innerHTML = html;
            },

            renderInsights() {
                const container = document.getElementById('insightsContainer');
                
                // Calculate insights
                const insights = [];
                
                // Hot priority contacts without recent communication
                const hotWithoutRecent = this.contacts.filter(c => 
                    c.priority === 'Hot' && 
                    (!c.communicationLog || c.communicationLog.length === 0 || 
                     (new Date() - new Date(c.communicationLog[0].date)) > 7 * 24 * 60 * 60 * 1000)
                );
                
                if (hotWithoutRecent.length > 0) {
                    insights.push({
                        type: 'urgent',
                        title: 'Hot Contacts Need Attention',
                        message: `${hotWithoutRecent.length} high-priority contact(s) haven't been contacted in over 7 days.`,
                        contacts: hotWithoutRecent
                    });
                }

                // High-touch velocity tracking
                const highTouchThisMonth = this.contacts.filter(c => {
                    if (!c.communicationLog) return false;
                    const thisMonth = new Date();
                    thisMonth.setDate(1);
                    thisMonth.setHours(0, 0, 0, 0);
                    
                    return c.communicationLog.some(log => {
                        const logDate = new Date(log.date);
                        return logDate >= thisMonth && 
                               ['Face-to-face meeting', 'Lunch/Dinner', 'Event together', 'Office visit'].includes(log.engagementType);
                    });
                }).length;

                if (highTouchThisMonth > 0) {
                    insights.push({
                        type: 'success',
                        title: 'High-Touch Momentum',
                        message: `${highTouchThisMonth} contact(s) had face-to-face meetings this month. Keep up the in-person engagement!`,
                        contacts: []
                    });
                }

                // Hot contacts with no face-to-face
                const hotNoFaceToFace = this.contacts.filter(c => 
                    c.priority === 'Hot' && countHighTouchInteractions(c) === 0
                );

                if (hotNoFaceToFace.length > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Hot Contacts Need Face-to-Face',
                        message: `${hotNoFaceToFace.length} Hot priority contact(s) have never had an in-person meeting. Consider scheduling.`,
                        contacts: hotNoFaceToFace
                    });
                }

                // Stuck in early stages with multiple touchpoints
                const stuckInEarlyStage = this.contacts.filter(c => 
                    (c.funnelStage === 'Unaware' || c.funnelStage === 'Awareness') && 
                    c.communicationLog && 
                    c.communicationLog.length >= 3
                );
                
                if (stuckInEarlyStage.length > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Multiple Touchpoints Without Progression',
                        message: `${stuckInEarlyStage.length} contact(s) have 3+ communications but remain in early stages. Consider a different approach or channel.`,
                        contacts: stuckInEarlyStage
                    });
                }

                // Dormant high-value contacts
                const dormantHighValue = this.contacts.filter(c => {
                    if (c.funnelStage !== 'Consideration' && c.funnelStage !== 'Active Conversation') return false;
                    if (!c.communicationLog || c.communicationLog.length === 0) return false;
                    
                    const lastContact = new Date(c.communicationLog[0].date);
                    const daysSince = Math.floor((new Date() - lastContact) / (1000 * 60 * 60 * 24));
                    return daysSince > 30;
                });

                if (dormantHighValue.length > 0) {
                    insights.push({
                        type: 'warning',
                        title: 'Dormant Opportunities',
                        message: `${dormantHighValue.length} contact(s) in Consideration/Active Conversation stages with no activity in 30+ days. Re-engage soon.`,
                        contacts: dormantHighValue
                    });
                }

                // Best performing channel
                const channelStats = {};
                this.contacts.forEach(c => {
                    if (c.communicationLog && c.communicationLog.length > 0) {
                        c.communicationLog.forEach(log => {
                            if (!channelStats[log.channel]) {
                                channelStats[log.channel] = { total: 0, responses: 0 };
                            }
                            channelStats[log.channel].total++;
                            if (log.response) channelStats[log.channel].responses++;
                        });
                    }
                });

                const channelPerformance = Object.entries(channelStats)
                    .map(([channel, stats]) => ({
                        channel,
                        rate: stats.total > 0 ? (stats.responses / stats.total * 100).toFixed(0) : 0
                    }))
                    .sort((a, b) => b.rate - a.rate);

                if (channelPerformance.length > 0 && channelPerformance[0].rate > 0) {
                    insights.push({
                        type: 'success',
                        title: 'Best Performing Channel',
                        message: `${channelPerformance[0].channel} has a ${channelPerformance[0].rate}% response rate‚Äîconsider prioritizing this channel for new outreach.`,
                        contacts: []
                    });
                }

                // Geographic concentration
                const countryCounts = {};
                this.contacts.forEach(c => {
                    if (c.country) {
                        countryCounts[c.country] = (countryCounts[c.country] || 0) + 1;
                    }
                });

                const totalWithCountry = Object.values(countryCounts).reduce((a, b) => a + b, 0);
                const topCountry = Object.entries(countryCounts).sort((a, b) => b[1] - a[1])[0];
                
                if (topCountry && totalWithCountry > 0) {
                    const concentration = Math.round((topCountry[1] / totalWithCountry) * 100);
                    if (concentration > 60) {
                        insights.push({
                            type: 'warning',
                            title: 'Geographic Concentration',
                            message: `${concentration}% of contacts are in ${topCountry[0]}. Consider diversifying geographically for risk mitigation.`,
                            contacts: []
                        });
                    }
                }

                // Industry gap detection
                const industryCounts = {};
                this.contacts.forEach(c => {
                    if (c.industryFocus) {
                        industryCounts[c.industryFocus] = (industryCounts[c.industryFocus] || 0) + 1;
                    }
                });

                const totalWithIndustry = Object.values(industryCounts).reduce((a, b) => a + b, 0);
                const industries = Object.keys(industryCounts);
                
                if (industries.length > 0 && industries.length <= 2 && totalWithIndustry > 5) {
                    insights.push({
                        type: 'warning',
                        title: 'Limited Industry Diversification',
                        message: `Only ${industries.length} industr${industries.length === 1 ? 'y' : 'ies'} represented (${industries.join(', ')}). Consider expanding to other sectors.`,
                        contacts: []
                    });
                }

                // Conversion velocity
                const convertedContacts = this.contacts.filter(c => c.funnelStage === 'Conversion' && c.communicationLog && c.communicationLog.length > 0);
                if (convertedContacts.length >= 3) {
                    const velocities = convertedContacts.map(c => {
                        const firstContact = new Date(c.communicationLog[c.communicationLog.length - 1].date);
                        const conversion = new Date(c.communicationLog[0].date);
                        return Math.floor((conversion - firstContact) / (1000 * 60 * 60 * 24));
                    });
                    const avgVelocity = Math.round(velocities.reduce((a, b) => a + b, 0) / velocities.length);
                    
                    insights.push({
                        type: 'success',
                        title: 'Conversion Velocity',
                        message: `Average time from first contact to conversion: ${avgVelocity} days. Track this to optimize your sales cycle.`,
                        contacts: []
                    });
                }

                // Communication burst analysis
                const contactsWithBursts = this.contacts.filter(c => {
                    if (!c.communicationLog || c.communicationLog.length < 2) return false;
                    
                    // Check if they had 2+ communications on the same day in the last 30 days
                    const recentLogs = c.communicationLog.filter(log => {
                        const daysSince = Math.floor((new Date() - new Date(log.date)) / (1000 * 60 * 60 * 24));
                        return daysSince <= 30;
                    });

                    const dateGroups = {};
                    recentLogs.forEach(log => {
                        const dateKey = new Date(log.date).toLocaleDateString();
                        dateGroups[dateKey] = (dateGroups[dateKey] || 0) + 1;
                    });

                    return Object.values(dateGroups).some(count => count >= 2);
                });

                if (contactsWithBursts.length > 0) {
                    insights.push({
                        type: 'success',
                        title: 'High-Intensity Engagement Days',
                        message: `${contactsWithBursts.length} contact(s) had multiple communications on the same day recently. These bursts often signal momentum.`,
                        contacts: contactsWithBursts
                    });
                }

                // Overdue actions
                const today = new Date();
                const overdue = this.contacts.filter(c => 
                    c.nextActionDate && new Date(c.nextActionDate) < today
                );

                if (overdue.length > 0) {
                    insights.push({
                        type: 'urgent',
                        title: 'Overdue Actions',
                        message: `${overdue.length} contact(s) have overdue follow-up actions.`,
                        contacts: overdue
                    });
                }

                if (insights.length === 0) {
                    container.innerHTML = '<div class="empty-state"><h3>No insights yet</h3><p>Add contacts and communications to generate strategic insights</p></div>';
                    return;
                }

                container.innerHTML = insights.map(insight => {
                    const colorMap = {
                        urgent: 'var(--priority-hot)',
                        warning: 'var(--priority-medium)',
                        success: 'var(--priority-low)'
                    };

                    return `
                        <div class="chart-card" style="border-left: 4px solid ${colorMap[insight.type]}; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.2rem; margin-bottom: 0.5rem;">${insight.title}</h3>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">${insight.message}</p>
                            ${insight.contacts.length > 0 ? `
                                <div style="margin-top: 1rem;">
                                    <strong style="font-size: 0.9rem;">Affected contacts:</strong>
                                    <div style="margin-top: 0.5rem;">
                                        ${insight.contacts.slice(0, 5).map(c => 
                                            `<span class="badge" style="margin-right: 0.5rem; margin-bottom: 0.5rem;">${c.company} - ${c.name}</span>`
                                        ).join('')}
                                        ${insight.contacts.length > 5 ? `<span style="color: var(--text-secondary); font-size: 0.85rem;">+${insight.contacts.length - 5} more</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            },

            updateStats() {
                document.getElementById('totalContacts').textContent = this.contacts.length;
                
                const active = this.contacts.filter(c => 
                    c.funnelStage !== 'Conversion' && c.connectionStatus !== 'Ignored'
                ).length;
                document.getElementById('activeOutreach').textContent = active;

                const conversions = this.contacts.filter(c => c.funnelStage === 'Conversion').length;
                document.getElementById('conversions').textContent = conversions;

                // Calculate response rate
                let totalCommunications = 0;
                let totalResponses = 0;
                this.contacts.forEach(c => {
                    if (c.communicationLog) {
                        totalCommunications += c.communicationLog.length;
                        totalResponses += c.communicationLog.filter(log => log.response).length;
                    }
                });

                const responseRate = totalCommunications > 0 
                    ? Math.round(totalResponses / totalCommunications * 100)
                    : 0;
                document.getElementById('responseRate').textContent = responseRate + '%';
            },

            renderCharts() {
                this.updateStats();

                // Funnel Chart - 6 stages
                const funnelData = {
                    Unaware: this.contacts.filter(c => c.funnelStage === 'Unaware').length,
                    Awareness: this.contacts.filter(c => c.funnelStage === 'Awareness').length,
                    Engaged: this.contacts.filter(c => c.funnelStage === 'Engaged').length,
                    Consideration: this.contacts.filter(c => c.funnelStage === 'Consideration').length,
                    'Active Conversation': this.contacts.filter(c => c.funnelStage === 'Active Conversation').length,
                    Conversion: this.contacts.filter(c => c.funnelStage === 'Conversion').length
                };

                if (this.charts.funnel) this.charts.funnel.destroy();
                this.charts.funnel = new Chart(document.getElementById('funnelChart'), {
                    type: 'bar',
                    data: {
                        labels: ['Unaware', 'Awareness', 'Engaged', 'Consideration', 'Active Conv.', 'Conversion'],
                        datasets: [{
                            label: 'Contacts',
                            data: Object.values(funnelData),
                            backgroundColor: [
                                'rgba(200, 200, 200, 0.6)',
                                'rgba(212, 165, 116, 0.7)',
                                'rgba(244, 164, 96, 0.7)',
                                'rgba(107, 142, 35, 0.7)',
                                'rgba(45, 80, 22, 0.7)',
                                'rgba(45, 80, 22, 0.9)'
                            ],
                            borderColor: [
                                'rgb(200, 200, 200)',
                                'rgb(212, 165, 116)',
                                'rgb(244, 164, 96)',
                                'rgb(107, 142, 35)',
                                'rgb(45, 80, 22)',
                                'rgb(45, 80, 22)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { stepSize: 1 } }
                        }
                    }
                });

                // Channel Effectiveness
                const channelData = {};
                this.contacts.forEach(c => {
                    if (c.communicationLog && c.communicationLog.length > 0) {
                        c.communicationLog.forEach(log => {
                            if (!channelData[log.channel]) {
                                channelData[log.channel] = { total: 0, responses: 0 };
                            }
                            channelData[log.channel].total++;
                            if (log.response) channelData[log.channel].responses++;
                        });
                    }
                });

                const channelLabels = Object.keys(channelData);
                const channelRates = channelLabels.map(channel => 
                    channelData[channel].total > 0 
                        ? (channelData[channel].responses / channelData[channel].total * 100).toFixed(1)
                        : 0
                );

                if (this.charts.channel) this.charts.channel.destroy();
                this.charts.channel = new Chart(document.getElementById('channelChart'), {
                    type: 'bar',
                    data: {
                        labels: channelLabels,
                        datasets: [{
                            label: 'Response Rate (%)',
                            data: channelRates,
                            backgroundColor: 'rgba(45, 80, 22, 0.7)',
                            borderColor: 'rgb(45, 80, 22)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, max: 100 }
                        }
                    }
                });

                // Tier Distribution
                const tierData = {
                    'Decision-maker': this.contacts.filter(c => c.tier === 'Decision-maker').length,
                    'Introducer': this.contacts.filter(c => c.tier === 'Introducer').length,
                    'Influencer': this.contacts.filter(c => c.tier === 'Influencer').length
                };

                if (this.charts.tier) this.charts.tier.destroy();
                this.charts.tier = new Chart(document.getElementById('tierChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(tierData),
                        datasets: [{
                            data: Object.values(tierData),
                            backgroundColor: [
                                'rgba(45, 80, 22, 0.8)',
                                'rgba(212, 165, 116, 0.8)',
                                'rgba(139, 69, 19, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });

                // Priority Distribution
                const priorityData = {
                    'Hot': this.contacts.filter(c => c.priority === 'Hot').length,
                    'Medium': this.contacts.filter(c => c.priority === 'Medium').length,
                    'Low': this.contacts.filter(c => c.priority === 'Low').length
                };

                if (this.charts.priority) this.charts.priority.destroy();
                this.charts.priority = new Chart(document.getElementById('priorityChart'), {
                    type: 'pie',
                    data: {
                        labels: Object.keys(priorityData),
                        datasets: [{
                            data: Object.values(priorityData),
                            backgroundColor: [
                                'rgba(196, 30, 58, 0.8)',
                                'rgba(244, 164, 96, 0.8)',
                                'rgba(107, 142, 35, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { position: 'bottom' }
                        }
                    }
                });
            },

            exportCSV() {
                const exportData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    contacts: this.contacts,
                    learnings: this.learnings,
                    templates: this.templates,
                    weeklyGoals: this.weeklyGoals,
                    weeklyGoalsHistory: this.weeklyGoalsHistory,
                    monthlyGoals: this.monthlyGoals,
                    monthlyGoalsHistory: this.monthlyGoalsHistory
                };
            
                const dataStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const filename = `outreach-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`‚úÖ Exported:\n‚Ä¢ ${this.contacts.length} contacts\n‚Ä¢ ${this.learnings.length} learnings\n‚Ä¢ ${this.templates.length} templates`);
            },
            
            importCSV(event) {
                const file = event.target.files[0];
                if (!file) return;
            
                // Check file type
                if (!file.name.endsWith('.json')) {
                    alert('Please select a JSON backup file');
                    event.target.value = '';
                    return;
                }
            
                const reader = new FileReader();
                
                reader.onload = (e) => {
                    try {
                        const importData = JSON.parse(e.target.result);
                        
                        // Validate
                        if (!importData.contacts || !Array.isArray(importData.contacts)) {
                            throw new Error('Invalid backup file');
                        }
            
                        const confirmMsg = `Import backup?\n\n` +
                            `‚Ä¢ ${importData.contacts?.length || 0} contacts\n` +
                            `‚Ä¢ ${importData.learnings?.length || 0} learnings\n` +
                            `‚Ä¢ ${importData.templates?.length || 0} templates\n\n` +
                            `This will merge with existing data.\nContinue?`;
                        
                        if (!confirm(confirmMsg)) {
                            event.target.value = '';
                            return;
                        }
            
                        let stats = {
                            contactsAdded: 0,
                            contactsUpdated: 0,
                            learningsAdded: 0,
                            learningsUpdated: 0,
                            templatesAdded: 0
                        };
            
                        // Import contacts
                        if (importData.contacts && Array.isArray(importData.contacts)) {
                            importData.contacts.forEach(imported => {
                                const existingIndex = this.contacts.findIndex(c => 
                                    c.company === imported.company && c.name === imported.name
                                );
                                
                                if (existingIndex >= 0) {
                                    imported.id = this.contacts[existingIndex].id;
                                    this.contacts[existingIndex] = imported;
                                    stats.contactsUpdated++;
                                } else {
                                    if (!imported.id) imported.id = generateUUID();
                                    this.contacts.push(imported);
                                    stats.contactsAdded++;
                                }
                            });
                        }
            
                        // Import learnings
                        if (importData.learnings && Array.isArray(importData.learnings)) {
                            importData.learnings.forEach(imported => {
                                const existingIndex = this.learnings.findIndex(l => 
                                    l.company === imported.company && l.weekStart === imported.weekStart
                                );
                                
                                if (existingIndex >= 0) {
                                    imported.id = this.learnings[existingIndex].id;
                                    this.learnings[existingIndex] = imported;
                                    stats.learningsUpdated++;
                                } else {
                                    if (!imported.id) imported.id = generateUUID();
                                    this.learnings.push(imported);
                                    stats.learningsAdded++;
                                }
                            });
                        }
            
                        // Import templates
                        if (importData.templates && Array.isArray(importData.templates)) {
                            importData.templates.forEach(imported => {
                                const exists = this.templates.some(t => t.name === imported.name);
                                if (!exists) {
                                    if (!imported.id) imported.id = generateUUID();
                                    this.templates.push(imported);
                                    stats.templatesAdded++;
                                }
                            });
                        }
            
                        // Import weekly goals
                        if (importData.weeklyGoals) {
                            const importWeekStart = new Date(importData.weeklyGoals.currentWeek);
                            const currentWeekStart = new Date(this.weeklyGoals.currentWeek);
                            
                            if (importWeekStart >= currentWeekStart) {
                                this.weeklyGoals = importData.weeklyGoals;
                            }
                        }
            
                        // Import weekly goals history
                        if (importData.weeklyGoalsHistory && Array.isArray(importData.weeklyGoalsHistory)) {
                            importData.weeklyGoalsHistory.forEach(imported => {
                                const exists = this.weeklyGoalsHistory.some(h => h.weekStart === imported.weekStart);
                                if (!exists) {
                                    this.weeklyGoalsHistory.push(imported);
                                }
                            });
                            this.weeklyGoalsHistory.sort((a, b) => new Date(b.weekStart) - new Date(a.weekStart));
                            this.weeklyGoalsHistory = this.weeklyGoalsHistory.slice(0, 12);
                        }
            
                        // Import monthly goals
                        if (importData.monthlyGoals) {
                            this.monthlyGoals = importData.monthlyGoals;
                        }
            
                        // Import monthly goals history
                        if (importData.monthlyGoalsHistory && Array.isArray(importData.monthlyGoalsHistory)) {
                            importData.monthlyGoalsHistory.forEach(imported => {
                                const exists = this.monthlyGoalsHistory.some(h => h.month === imported.month);
                                if (!exists) {
                                    this.monthlyGoalsHistory.push(imported);
                                }
                            });
                            this.monthlyGoalsHistory.sort((a, b) => new Date(b.month) - new Date(a.month));
                            this.monthlyGoalsHistory = this.monthlyGoalsHistory.slice(0, 12);
                        }
            
                        // Save and refresh
                        this.saveData();
                        this.populateTagFilter();
                        this.populateIndustryFilter();
                        this.renderContacts();
                        this.renderLearnings();
                        this.renderTemplates();
                        this.renderCalendar();
                        this.renderCharts();
                        this.renderInsights();
                        
                        const resultMsg = `‚úÖ Import complete!\n\n` +
                            `Contacts: ${stats.contactsAdded} added, ${stats.contactsUpdated} updated\n` +
                            `Learnings: ${stats.learningsAdded} added, ${stats.learningsUpdated} updated\n` +
                            `Templates: ${stats.templatesAdded} added`;
                        
                        alert(resultMsg);
                        
                    } catch (error) {
                        console.error('Import error:', error);
                        alert(`Error importing file: ${error.message}`);
                    }
                };
                
                reader.onerror = () => {
                    alert('Error reading file');
                };
                
                reader.readAsText(file);
                event.target.value = '';
            },

            setupFridayReminder() {
                // Check every hour if it's Friday 5 PM
                setInterval(() => {
                    const now = new Date();
                    const isFriday = now.getDay() === 5;
                    const hour = now.getHours();
                    const minute = now.getMinutes();
                    
                    // Friday at 5 PM (between 17:00 and 17:05)
                    if (isFriday && hour === 17 && minute < 5) {
                        const lastPrompt = localStorage.getItem('last_learning_prompt');
                        const today = now.toDateString();
                        
                        // Only prompt once per Friday
                        if (lastPrompt !== today) {
                            this.showFridayLearningNotification();
                            localStorage.setItem('last_learning_prompt', today);
                        }
                    }
                }, 60000); // Check every minute
            },

            showFridayLearningNotification() {
                const companiesThisWeek = this.getCompaniesWithActivityThisWeek();
                
                if (companiesThisWeek.length === 0) return;

                if (confirm(`üìö Weekly Learning Check-in\n\nYou had activity with ${companiesThisWeek.length} companies this week.\n\nReady to log your learnings?`)) {
                    this.openWeeklyLearningPrompt();
                }
            },

            getCompaniesWithActivityThisWeek() {
                const weekStart = this.getWeekStart();
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 5); // Monday to Friday

                return this.contacts.filter(contact => {
                    if (!contact.communicationLog || contact.communicationLog.length === 0) return false;
                    
                    return contact.communicationLog.some(log => {
                        const logDate = new Date(log.date);
                        return logDate >= weekStart && logDate < weekEnd;
                    });
                });
            },

            getWeekStart(date = new Date()) {
                const d = new Date(date);
                const day = d.getDay();
                // If it's Saturday (6) or Sunday (0), go back to previous Monday
                if (day === 0) { // Sunday
                    d.setDate(d.getDate() - 6);
                } else if (day === 6) { // Saturday
                    d.setDate(d.getDate() - 5);
                } else {
                    // Weekday - go back to Monday
                    const diff = d.getDate() - day + 1; // +1 because Monday is 1
                    d.setDate(diff);
                }
                d.setHours(0, 0, 0, 0);
                return d;
            },

            openWeeklyLearningPrompt() {
                // Switch to learnings tab
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                document.querySelector('[data-tab="learnings"]').classList.add('active');
                document.getElementById('learnings').classList.add('active');
                
                this.renderLearnings();
            },

            renderLearnings() {
                this.renderWeeklyGoals();
                this.renderMonthlyGoals();
                this.renderThisWeekLearnings();
                this.renderPatternDetection();
                this.render();
            },

            renderWeeklyGoals() {
                const container = document.getElementById('weeklyGoalsCard');
                if (!container) return;
                
                this.checkAndResetWeeklyGoals();
                this.updateWeeklyGoalsProgress();
                
                const weekStart = new Date(this.weeklyGoals.currentWeek);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 4); // Monday to Friday = 4 days difference
                const weekLabel = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} (Mon-Fri)`;
                
                const goals = this.weeklyGoals;
                
                const getStatus = (current, target) => {
                    const percent = (current / target) * 100;
                    if (percent >= 100) return '‚úÖ';
                    if (percent >= 70) return 'üü°';
                    return '‚è≥';
                };
                
                container.innerHTML = `
                    <div class="chart-card">
                        <h3 style="margin-bottom: 1.5rem;">Weekly Goals - ${weekLabel}</h3>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 0.25rem;">
                            ${Object.keys(goals).filter(k => k.startsWith('goal')).map(key => {
                                const goal = goals[key];
                                return `
                                    <div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">${goal.label}</span>
                                            <span>${getStatus(goal.current, goal.target)}</span>
                                        </div>
                                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--core-green);">
                                            ${goal.current}/${goal.target}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        ${goals.insight ? `
                            <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(45, 80, 22, 0.05); border-left: 3px solid var(--core-green); border-radius: 4px;">
                                <strong style="font-size: 0.9rem; color: var(--core-green);">üí° This Week's Insight:</strong>
                                <div style="font-size: 0.9rem; color: var(--text-primary); margin-top: 0.5rem; line-height: 1.6;">${goals.insight}</div>
                            </div>
                        ` : ''}
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn" onclick="app.editWeeklyTargets()" style="font-size: 0.85rem;">üéØ Edit Targets</button>
                            <button class="btn" onclick="app.editWeeklyProgress()" style="font-size: 0.85rem;">üìä Update Progress (Goals 3-5)</button>
                            <button class="btn btn-primary" onclick="app.addWeeklyInsight()" style="font-size: 0.85rem;">üí° Add Insight</button>
                            <button class="btn" onclick="app.viewWeeklyGoalsHistory()" style="font-size: 0.85rem;">üìä View History</button>
                        </div>
                    </div>
                `;
            },

            renderMonthlyGoals() {
                const container = document.getElementById('monthlyGoalsCard');
                const now = new Date();
                const monthName = now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

                const goals = this.monthlyGoals;
                
                // Calculate traction density (goal2 / goal1)
                const tractionDensity = goals.goal1.current > 0 
                    ? ((goals.goal2.current / goals.goal1.current) * 100).toFixed(1)
                    : 0;

                const getStatus = (current, target) => {
                    const percent = (current / target) * 100;
                    if (percent >= 100) return '‚úÖ';
                    if (percent >= 70) return 'üü°';
                    return '‚è≥';
                };

                container.innerHTML = `
                    <div class="chart-card">
                        <h3 style="margin-bottom: 1.5rem;">Monthly Goals - ${monthName}</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                            ${Object.keys(goals).map(key => {
                                const goal = goals[key];
                                return `
                                    <div>
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                                            <span style="font-size: 0.9rem; color: var(--text-secondary);">${goal.label}</span>
                                            <span>${getStatus(goal.current, goal.target)}</span>
                                        </div>
                                        <div style="font-size: 1.5rem; font-weight: 600; color: var(--core-green);">
                                            ${goal.current}/${goal.target}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                            <div style="border-left: 2px solid var(--border-color); padding-left: 1rem;">
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Traction Density</div>
                                <div style="font-size: 1.5rem; font-weight: 600; color: var(--priority-${tractionDensity >= 15 ? 'low' : tractionDensity >= 10 ? 'medium' : 'hot'});">
                                    ${tractionDensity}%
                                </div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    (${goals.goal2.label} / ${goals.goal1.label})
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                            <button class="btn" onclick="app.editGoalLabels()" style="font-size: 0.85rem;">‚úèÔ∏è Edit Labels</button>
                            <button class="btn" onclick="app.editGoalTargets()" style="font-size: 0.85rem;">üéØ Edit Targets</button>
                            <button class="btn" onclick="app.editGoalProgress()" style="font-size: 0.85rem;">üìä Update Progress</button>
                            <button class="btn" onclick="app.viewMonthlyGoalsHistory()" style="font-size: 0.85rem;">üìä View History</button>
                        </div>
                    </div>
                `;
            },

            updateMonthlyGoalsProgress() {
                // Auto-calculate goal1 and goal2
                const thisMonth = new Date();
                thisMonth.setDate(1);
                thisMonth.setHours(0, 0, 0, 0);

                // Goal 1: New contacts (all contacts for now - ideally track creation date)
                this.monthlyGoals.goal1.current = this.contacts.length;

                // Goal 2: Meaningful conversations (Engaged or higher)
                this.monthlyGoals.goal2.current = this.contacts.filter(c => {
                    return ['Engaged', 'Consideration', 'Active Conversation', 'Conversion'].includes(c.funnelStage);
                }).length;

                // Goals 3, 4, 5 remain manual (articles, case studies, partnerships)
            },

            updateWeeklyGoalsProgress() {
                const weekStart = this.getWeekStart();
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 5); // Monday to Friday
                
                // Goal 1: New Contacts added this week
                const newContactsThisWeek = this.contacts.filter(c => {
                    if (!c.createdAt) return false; // If no createdAt, assume old contact
                    const createdDate = new Date(c.createdAt);
                    return createdDate >= weekStart && createdDate < weekEnd;
                });
                this.weeklyGoals.goal1.current = newContactsThisWeek.length;
                
                // Goal 2: Meaningful Conversations (Engaged or higher with activity this week)
                const meaningfulConvosThisWeek = this.contacts.filter(c => {
                    if (!['Engaged', 'Consideration', 'Active Conversation', 'Conversion'].includes(c.funnelStage)) {
                        return false;
                    }
                    
                    // Check if they had communication this week
                    if (!c.communicationLog || c.communicationLog.length === 0) return false;
                    
                    return c.communicationLog.some(log => {
                        const logDate = new Date(log.date);
                        return logDate >= weekStart && logDate < weekEnd;
                    });
                });
                this.weeklyGoals.goal2.current = meaningfulConvosThisWeek.length;
                
                // Goals 3, 4, 5 remain manual
            },
            

            editGoalLabels() {
                const goals = this.monthlyGoals;
                const newLabels = prompt(
                    `Edit Goal Labels (one per line):\n\n` +
                    `Current labels:\n` +
                    `1. ${goals.goal1.label}\n` +
                    `2. ${goals.goal2.label}\n` +
                    `3. ${goals.goal3.label}\n` +
                    `4. ${goals.goal4.label}\n` +
                    `5. ${goals.goal5.label}\n\n` +
                    `Enter new labels (comma-separated):`,
                    `${goals.goal1.label},${goals.goal2.label},${goals.goal3.label},${goals.goal4.label},${goals.goal5.label}`
                );

                if (newLabels) {
                    const labels = newLabels.split(',').map(l => l.trim());
                    if (labels.length === 5) {
                        goals.goal1.label = labels[0];
                        goals.goal2.label = labels[1];
                        goals.goal3.label = labels[2];
                        goals.goal4.label = labels[3];
                        goals.goal5.label = labels[4];
                        
                        this.saveData();
                        this.renderMonthlyGoals();
                    } else {
                        alert('Please enter exactly 5 labels separated by commas.');
                    }
                }
            },

            editGoalTargets() {
                const goals = this.monthlyGoals;
                const newTargets = prompt(
                    `Edit Monthly Targets (one per line):\n\n` +
                    `Current:\n` +
                    `1. ${goals.goal1.label}: ${goals.goal1.target}\n` +
                    `2. ${goals.goal2.label}: ${goals.goal2.target}\n` +
                    `3. ${goals.goal3.label}: ${goals.goal3.target}\n` +
                    `4. ${goals.goal4.label}: ${goals.goal4.target}\n` +
                    `5. ${goals.goal5.label}: ${goals.goal5.target}\n\n` +
                    `Enter new targets (comma-separated numbers):`,
                    `${goals.goal1.target},${goals.goal2.target},${goals.goal3.target},${goals.goal4.target},${goals.goal5.target}`
                );

                if (newTargets) {
                    const targets = newTargets.split(',').map(t => parseInt(t.trim()));
                    if (targets.length === 5 && targets.every(t => !isNaN(t) && t > 0)) {
                        goals.goal1.target = targets[0];
                        goals.goal2.target = targets[1];
                        goals.goal3.target = targets[2];
                        goals.goal4.target = targets[3];
                        goals.goal5.target = targets[4];
                        
                        this.saveData();
                        this.renderMonthlyGoals();
                    } else {
                        alert('Please enter 5 valid positive numbers separated by commas.');
                    }
                }
            },

            editGoalProgress() {
                const goals = this.monthlyGoals;
                const newProgress = prompt(
                    `Update Current Progress:\n\n` +
                    `Note: Goal 1 & 2 auto-calculate from contacts.\n` +
                    `Manually update Goals 3, 4, 5:\n\n` +
                    `3. ${goals.goal3.label}: ${goals.goal3.current}/${goals.goal3.target}\n` +
                    `4. ${goals.goal4.label}: ${goals.goal4.current}/${goals.goal4.target}\n` +
                    `5. ${goals.goal5.label}: ${goals.goal5.current}/${goals.goal5.target}\n\n` +
                    `Enter current progress for goals 3, 4, 5 (comma-separated):`,
                    `${goals.goal3.current},${goals.goal4.current},${goals.goal5.current}`
                );

                if (newProgress) {
                    const progress = newProgress.split(',').map(p => parseInt(p.trim()));
                    if (progress.length === 3 && progress.every(p => !isNaN(p) && p >= 0)) {
                        goals.goal3.current = progress[0];
                        goals.goal4.current = progress[1];
                        goals.goal5.current = progress[2];
                        
                        this.saveData();
                        this.renderMonthlyGoals();
                    } else {
                        alert('Please enter 3 valid numbers (0 or greater) separated by commas.');
                    }
                }
            },

            archiveMonthlyGoals() {
                const now = new Date();
                const monthKey = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                
                const archived = {
                    month: monthKey,
                    monthName: now.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }),
                    goals: JSON.parse(JSON.stringify(this.monthlyGoals)),
                    archivedAt: new Date().toISOString()
                };
                
                this.monthlyGoalsHistory.unshift(archived);
                
                // Keep only last 12 months
                if (this.monthlyGoalsHistory.length > 12) {
                    this.monthlyGoalsHistory = this.monthlyGoalsHistory.slice(0, 12);
                }
                
                this.saveData();
                alert('‚úÖ Monthly goals archived! You can now reset your goals for the new month.');
            },

            viewMonthlyGoalsHistory() {
                if (this.monthlyGoalsHistory.length === 0) {
                    alert('No monthly goals history yet. Use "Archive Current Month" at month-end to start tracking history.');
                    return;
                }
                
                const getStatus = (current, target) => {
                    const percent = (current / target) * 100;
                    if (percent >= 100) return '‚úÖ';
                    if (percent >= 70) return 'üü°';
                    return '‚è≥';
                };
                
                const modalHTML = `
                    <div class="modal active" id="monthlyHistoryModal" style="z-index: 1001;">
                        <div class="modal-content" style="max-width: 900px;">
                            <div class="modal-header">
                                <h2>Monthly Goals History</h2>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                                    Past ${this.monthlyGoalsHistory.length} month${this.monthlyGoalsHistory.length !== 1 ? 's' : ''}
                                </p>
                            </div>
                            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                                ${this.monthlyGoalsHistory.map(record => {
                                    const goals = record.goals;
                                    const tractionDensity = goals.goal1.current > 0 
                                        ? ((goals.goal2.current / goals.goal1.current) * 100).toFixed(1)
                                        : 0;
                                    
                                    return `
                                        <div class="chart-card" style="margin-bottom: 1rem;">
                                            <h4 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--core-green);">${record.monthName}</h4>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem;">
                                                ${Object.keys(goals).map(key => {
                                                    const goal = goals[key];
                                                    return `
                                                        <div style="font-size: 0.85rem;">
                                                            <div style="color: var(--text-secondary); margin-bottom: 0.25rem;">${goal.label}</div>
                                                            <div style="font-size: 1.2rem; font-weight: 600; color: var(--core-green);">
                                                                ${goal.current}/${goal.target} ${getStatus(goal.current, goal.target)}
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                                <div style="border-left: 2px solid var(--border-color); padding-left: 0.75rem;">
                                                    <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Traction Density</div>
                                                    <div style="font-size: 1.2rem; font-weight: 600; color: var(--priority-${tractionDensity >= 15 ? 'low' : tractionDensity >= 10 ? 'medium' : 'hot'});">
                                                        ${tractionDensity}%
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="modal-footer">
                                <button class="btn btn-primary" onclick="app.archiveMonthlyGoals(); app.closeMonthlyHistoryModal();">üì¶ Archive Current Month</button>
                                <button class="btn" onclick="app.closeMonthlyHistoryModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            },
            
            closeMonthlyHistoryModal() {
                const modal = document.getElementById('monthlyHistoryModal');
                if (modal) modal.remove();
            },

            editWeeklyTargets() {
                const goals = this.weeklyGoals;
                const newTargets = prompt(
                    `Edit Weekly Targets:\n\n` +
                    `1. ${goals.goal1.label}: ${goals.goal1.target}\n` +
                    `2. ${goals.goal2.label}: ${goals.goal2.target}\n` +
                    `3. ${goals.goal3.label}: ${goals.goal3.target}\n` +
                    `4. ${goals.goal4.label}: ${goals.goal4.target}\n` +
                    `5. ${goals.goal5.label}: ${goals.goal5.target}\n\n` +
                    `Enter new targets (comma-separated):`,
                    `${goals.goal1.target},${goals.goal2.target},${goals.goal3.target},${goals.goal4.target},${goals.goal5.target}`
                );
            
                if (newTargets) {
                    const targets = newTargets.split(',').map(t => parseInt(t.trim()));
                    if (targets.length === 5 && targets.every(t => !isNaN(t) && t >= 0)) {
                        goals.goal1.target = targets[0];
                        goals.goal2.target = targets[1];
                        goals.goal3.target = targets[2];
                        goals.goal4.target = targets[3];
                        goals.goal5.target = targets[4];
                        
                        this.saveData();
                        this.renderWeeklyGoals();
                    } else {
                        alert('Please enter 5 valid numbers (0 or greater) separated by commas.');
                    }
                }
            },
            
            editWeeklyProgress() {
                const goals = this.weeklyGoals;
                const newProgress = prompt(
                    `Update Weekly Progress:\n\n` +
                    `Note: Goals 1 & 2 auto-calculate from contacts.\n` +
                    `Manually update Goals 3, 4, 5:\n\n` +
                    `3. ${goals.goal3.label}: ${goals.goal3.current}/${goals.goal3.target}\n` +
                    `4. ${goals.goal4.label}: ${goals.goal4.current}/${goals.goal4.target}\n` +
                    `5. ${goals.goal5.label}: ${goals.goal5.current}/${goals.goal5.target}\n\n` +
                    `Enter current progress for goals 3, 4, 5 (comma-separated):`,
                    `${goals.goal3.current},${goals.goal4.current},${goals.goal5.current}`
                );
            
                if (newProgress) {
                    const progress = newProgress.split(',').map(p => parseInt(p.trim()));
                    if (progress.length === 3 && progress.every(p => !isNaN(p) && p >= 0)) {
                        goals.goal3.current = progress[0];
                        goals.goal4.current = progress[1];
                        goals.goal5.current = progress[2];
                        
                        this.saveData();
                        this.renderWeeklyGoals();
                    } else {
                        alert('Please enter 3 valid numbers (0 or greater) separated by commas.');
                    }
                }
            },

            addWeeklyInsight() {
                const weekStart = new Date(this.weeklyGoals.currentWeek);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 4);
                const weekLabel = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                
                const currentInsight = this.weeklyGoals.insight || '';
                
                const newInsight = prompt(
                    `Weekly Insight (${weekLabel}):\n\n` +
                    `What's the key pattern or realization from this week?\n\n` +
                    `Current insight:`,
                    currentInsight
                );
                
                if (newInsight !== null) {
                    this.weeklyGoals.insight = newInsight.trim();
                    this.saveData();
                    this.renderWeeklyGoals();
                }
            },

            viewWeeklyGoalsHistory() {
                if (this.weeklyGoalsHistory.length === 0) {
                    alert('No weekly goals history yet. History starts accumulating after your first week ends.');
                    return;
                }
                
                const getStatus = (current, target) => {
                    const percent = (current / target) * 100;
                    if (percent >= 100) return '‚úÖ';
                    if (percent >= 70) return 'üü°';
                    return '‚è≥';
                };
                
                const modalHTML = `
                    <div class="modal active" id="weeklyHistoryModal" style="z-index: 1001;">
                        <div class="modal-content" style="max-width: 900px;">
                            <div class="modal-header">
                                <h2>Weekly Goals History</h2>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                                    Past ${this.weeklyGoalsHistory.length} week${this.weeklyGoalsHistory.length !== 1 ? 's' : ''}
                                </p>
                            </div>
                            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                                ${this.weeklyGoalsHistory.map((record, idx) => {
                                    const weekStart = new Date(record.weekStart);
                                    const weekEnd = new Date(weekStart);
                                    weekEnd.setDate(weekEnd.getDate() + 4);
                                    const weekLabel = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                                    
                                    const goals = record.goals;
                                    
                                    return `
                                        <div class="chart-card" style="margin-bottom: 1rem;">
                                            <h4 style="font-size: 1.1rem; margin-bottom: 1rem; color: var(--core-green);">${weekLabel}</h4>
                                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.75rem; margin-bottom: 1rem;">
                                                ${Object.keys(goals).filter(k => k.startsWith('goal')).map(key => {
                                                    const goal = goals[key];
                                                    return `
                                                        <div style="font-size: 0.85rem;">
                                                            <div style="color: var(--text-secondary); margin-bottom: 0.25rem;">${goal.label}</div>
                                                            <div style="font-size: 1.2rem; font-weight: 600; color: var(--core-green);">
                                                                ${goal.current}/${goal.target} ${getStatus(goal.current, goal.target)}
                                                            </div>
                                                        </div>
                                                    `;
                                                }).join('')}
                                            </div>
                                            ${goals.insight ? `
                                                <div style="padding: 0.75rem; background: rgba(45, 80, 22, 0.05); border-left: 3px solid var(--core-green); border-radius: 4px;">
                                                    <strong style="font-size: 0.85rem; color: var(--core-green);">üí° Insight:</strong>
                                                    <div style="font-size: 0.85rem; color: var(--text-primary); margin-top: 0.25rem;">${goals.insight}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                            <div class="modal-footer">
                                <button class="btn" onclick="app.closeWeeklyHistoryModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            },
            
            closeWeeklyHistoryModal() {
                const modal = document.getElementById('weeklyHistoryModal');
                if (modal) modal.remove();
            },

            // ADD this new function
            toggleDeepDiveMode() {
                const simpleMode = document.getElementById('simpleModeFields');
                const deepDiveMode = document.getElementById('deepDiveModeFields');
                
                if (simpleMode.classList.contains('hidden')) {
                    simpleMode.classList.remove('hidden');
                    deepDiveMode.classList.add('hidden');
                } else {
                    simpleMode.classList.add('hidden');
                    deepDiveMode.classList.remove('hidden');
                }
            },

            // REPLACE renderThisWeekLearnings() entirely (around line 1600)
            renderThisWeekLearnings() {
                const container = document.getElementById('thisWeekLearnings');
                const weekStart = this.getWeekStart();
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 5); // Monday to Friday = 5 days (inclusive)
            
                // Group contacts by company that had activity this week
                const companiesMap = {};
                
                this.contacts.forEach(contact => {
                    if (!contact.communicationLog) return;
                    
                    const weekActivity = contact.communicationLog.filter(log => {
                        const logDate = new Date(log.date);
                        return logDate >= weekStart && logDate < weekEnd;
                    });
                    
                    if (weekActivity.length > 0) {
                        if (!companiesMap[contact.company]) {
                            companiesMap[contact.company] = {
                                company: contact.company,
                                people: [],
                                totalActivity: 0
                            };
                        }
                        
                        companiesMap[contact.company].people.push({
                            name: contact.name,
                            tier: contact.tier,
                            activity: weekActivity,
                            contactId: contact.id
                        });
                        companiesMap[contact.company].totalActivity += weekActivity.length;
                    }
                });
            
                const companies = Object.values(companiesMap);
                const learningsThisWeek = this.learnings.filter(l => l.weekStart === weekStart.toISOString().split('T')[0]);
                
                // weekEnd already declared earlier in function - just reuse it
                const weekEndDisplay = new Date(weekStart);
                weekEndDisplay.setDate(weekEndDisplay.getDate() + 4); // For display: Mon to Fri
                const weekLabel = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEndDisplay.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} (Mon-Fri)`;
            
                container.innerHTML = `
                    <div class="chart-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3>üìÖ This Week (${weekLabel})</h3>
                            <button class="btn" onclick="app.showPastWeeksSelector()" style="font-size: 0.85rem;">
                                üìÖ View Past Weeks
                            </button>
                        </div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 1.5rem 0; padding: 1rem; background: var(--bg-primary); border-radius: 8px;">
                            <div>
                                <div style="font-size: 1.3rem; font-weight: 600; color: var(--core-green);">
                                    ${companies.reduce((sum, c) => sum + c.people.length, 0)} people from ${companies.length} companies with activity
                                </div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                    ${learningsThisWeek.length} learnings logged | ${companies.length - learningsThisWeek.length} companies pending
                                </div>
                            </div>
                        </div>
            
                        ${companies.length === 0 ? `
                            <div class="empty-state">
                                <p>No activity this week yet</p>
                            </div>
                        ` : `
                            <div style="display: grid; gap: 1rem;">
                                ${companies.map(companyData => {
                                    const hasLearning = learningsThisWeek.find(l => l.company === companyData.company);
                                    const sortedPeople = companyData.people.sort((a, b) => 
                                        b.activity.length - a.activity.length
                                    );
                                    const topPeople = sortedPeople.slice(0, 3);
                                    const remainingCount = sortedPeople.length - 3;
            
                                    return `
                                        <div style="padding: 1.5rem; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid ${hasLearning ? 'var(--core-green)' : 'var(--priority-medium)'};">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                                <div style="flex: 1;">
                                                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                                        <span style="font-size: 1.3rem;">${hasLearning ? '‚úÖ' : '‚è≥'}</span>
                                                        <h4 style="font-size: 1.2rem; font-weight: 600; margin: 0;">${companyData.company}</h4>
                                                    </div>
                                                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                                                        Spoke with: <strong>${companyData.people.length} person${companyData.people.length !== 1 ? 's' : ''}</strong>
                                                    </div>
                                                    
                                                    <div style="margin-left: 1rem; font-size: 0.9rem; line-height: 1.8;">
                                                        ${topPeople.map(person => {
                                                            const latestActivity = person.activity.sort((a, b) => 
                                                                new Date(b.date) - new Date(a.date)
                                                            )[0];
                                                            const activityDate = new Date(latestActivity.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                                            return `
                                                                <div>‚Ä¢ ${person.name} <span class="badge" style="font-size: 0.75rem;">${person.tier}</span> - ${latestActivity.channel}, ${activityDate}</div>
                                                            `;
                                                        }).join('')}
                                                        ${remainingCount > 0 ? `
                                                            <div style="color: var(--text-secondary); font-style: italic; margin-top: 0.25rem;">
                                                                (+ ${remainingCount} more)
                                                            </div>
                                                        ` : ''}
                                                    </div>
                                                </div>
                                                <button class="btn" onclick="app.openLearningModalForCompany('${companyData.company}', '${weekStart.toISOString().split('T')[0]}')" style="font-size: 0.85rem; flex-shrink: 0;">
                                                    ${hasLearning ? 'üìñ View' : 'üìù Log Learning'}
                                                </button>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `}
                    </div>
                `;
            },

            renderPatternDetection() {
            const container = document.getElementById('patternDetection');
            
            if (this.learnings.length < 3) {
                container.innerHTML = '';
                return;
            }
        
            const patterns = [];
        
            // Reroute pattern
            const reroutes = this.learnings.filter(l => l.nextMove === 'Reroute');
            if (reroutes.length >= 3) {
                patterns.push({
                    type: 'warning',
                    title: `${reroutes.length} companies marked "Reroute"`,
                    message: `Consider reviewing your approach or messaging strategy`
                });
            }
        
            // Signal strength trend
            const recentLearnings = this.learnings.slice(-10);
            const strongSignals = recentLearnings.filter(l => l.signal === 'Strong').length;
            const moderateSignals = recentLearnings.filter(l => l.signal === 'Moderate').length;
            const signalPercent = ((strongSignals + moderateSignals) / recentLearnings.length * 100).toFixed(0);
            
            if (signalPercent >= 60) {
                patterns.push({
                    type: 'success',
                    title: 'Signal Strength Improving',
                    message: `${signalPercent}% of recent engagements showing Moderate/Strong signals`
                });
            }
        
            // Companies being dropped
            const dropped = this.learnings.filter(l => l.nextMove === 'Drop it');
            if (dropped.length >= 3) {
                patterns.push({
                    type: 'warning',
                    title: `${dropped.length} companies dropped`,
                    message: `Review if there's a pattern in why these didn't work out`
                });
            }
        
            if (patterns.length === 0) {
                container.innerHTML = '';
                return;
            }
        
            const colorMap = {
                success: 'var(--priority-low)',
                warning: 'var(--priority-medium)',
                urgent: 'var(--priority-hot)'
            };
        
            container.innerHTML = `
                <div class="chart-card">
                    <h3>üìä Pattern Detection</h3>
                    <div style="display: grid; gap: 1rem; margin-top: 1.5rem;">
                        ${patterns.map(pattern => `
                            <div style="padding: 1rem; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid ${colorMap[pattern.type]};">
                                <div style="font-weight: 600; margin-bottom: 0.5rem;">${pattern.title}</div>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">${pattern.message}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        },

            renderPastLearnings(searchTerm = '') {
                const container = document.getElementById('pastLearnings');
                
                let filteredLearnings = this.learnings.filter(l => {
                    const weekStart = this.getWeekStart();
                    return l.weekStart !== weekStart.toISOString().split('T')[0];
                });
            
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredLearnings = filteredLearnings.filter(l => 
                        l.company.toLowerCase().includes(term) ||
                        l.signal.toLowerCase().includes(term) ||
                        l.nextMove.toLowerCase().includes(term) ||
                        l.takeaway.toLowerCase().includes(term)
                    );
                }
            
                if (filteredLearnings.length === 0) {
                    container.innerHTML = '<div class="empty-state"><p>No past learnings yet.</p></div>';
                    return;
                }
            
                // Group by week
                const groupedByWeek = {};
                filteredLearnings.forEach(learning => {
                    if (!groupedByWeek[learning.weekStart]) {
                        groupedByWeek[learning.weekStart] = [];
                    }
                    groupedByWeek[learning.weekStart].push(learning);
                });
            
                const sortedWeeks = Object.keys(groupedByWeek).sort().reverse();
            
                // Compact table view
                container.innerHTML = `
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 180px;">Week</th>
                                    <th style="width: 100px; text-align: center;">Companies</th>
                                    <th style="width: 120px; text-align: center;">Signals</th>
                                    <th style="width: 150px; text-align: center;">Next Moves</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                ${sortedWeeks.map(weekStart => {
                                    const weekEnd = new Date(weekStart);
                                    weekEnd.setDate(weekEnd.getDate() + 4);
                                    const weekLabel = `${new Date(weekStart).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
                                    const learnings = groupedByWeek[weekStart];
                                    
                                    // Count signals
                                    const signals = {
                                        strong: learnings.filter(l => l.signal === 'Strong').length,
                                        moderate: learnings.filter(l => l.signal === 'Moderate').length,
                                        weak: learnings.filter(l => l.signal === 'Weak').length
                                    };
                                    
                                    // Count next moves
                                    const moves = {
                                        push: learnings.filter(l => l.nextMove === 'Keep pushing').length,
                                        reroute: learnings.filter(l => l.nextMove === 'Reroute').length,
                                        wait: learnings.filter(l => l.nextMove === 'Wait').length,
                                        drop: learnings.filter(l => l.nextMove === 'Drop it').length
                                    };
                                    
                                    return `
                                        <tr style="cursor: pointer;" onclick="app.expandWeekLearnings('${weekStart}')">
                                            <td><strong>${weekLabel}</strong></td>
                                            <td style="text-align: center;">
                                                <span class="badge">${learnings.length} ${learnings.length === 1 ? 'company' : 'companies'}</span>
                                            </td>
                                            <td style="text-align: center;">
                                                ${signals.strong > 0 ? `<span style="font-size: 1.1rem;" title="${signals.strong} Strong">üü¢${signals.strong}</span> ` : ''}
                                                ${signals.moderate > 0 ? `<span style="font-size: 1.1rem;" title="${signals.moderate} Moderate">üü°${signals.moderate}</span> ` : ''}
                                                ${signals.weak > 0 ? `<span style="font-size: 1.1rem;" title="${signals.weak} Weak">üî¥${signals.weak}</span>` : ''}
                                            </td>
                                            <td style="text-align: center; font-size: 0.85rem;">
                                                ${moves.push > 0 ? `Push: ${moves.push} ` : ''}
                                                ${moves.reroute > 0 ? `Reroute: ${moves.reroute} ` : ''}
                                                ${moves.wait > 0 ? `Wait: ${moves.wait} ` : ''}
                                                ${moves.drop > 0 ? `Drop: ${moves.drop}` : ''}
                                            </td>
                                            <td style="text-align: right;">
                                                <button class="btn" style="font-size: 0.85rem; padding: 0.5rem 1rem;" onclick="event.stopPropagation(); app.expandWeekLearnings('${weekStart}')">
                                                    View Details ‚Üí
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            },

            expandWeekLearnings(weekStart) {
                const learnings = this.learnings.filter(l => l.weekStart === weekStart);
                
                if (learnings.length === 0) return;
                
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 4);
                const weekLabel = `${new Date(weekStart).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                
                const modalHTML = `
                    <div class="modal active" id="weekLearningsModal" style="z-index: 1001;">
                        <div class="modal-content" style="max-width: 900px;">
                            <div class="modal-header">
                                <h2>Week of ${weekLabel}</h2>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                                    ${learnings.length} learning${learnings.length !== 1 ? 's' : ''} logged
                                </p>
                            </div>
                            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                                <div style="display: grid; gap: 1rem;">
                                    ${learnings.map(learning => {
                                        const signalColor = learning.signal === 'Strong' ? 'low' : learning.signal === 'Moderate' ? 'medium' : 'hot';
                                        return `
                                            <div class="chart-card" style="margin: 0; cursor: pointer;" onclick="app.viewLearningDetail('${learning.id}'); app.closeWeekLearningsModal();">
                                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                                    <div>
                                                        <h4 style="font-size: 1.1rem; margin-bottom: 0.5rem;">${learning.company}</h4>
                                                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                                            <span class="badge priority-${signalColor}">
                                                                ${learning.signal === 'Strong' ? 'üü¢' : learning.signal === 'Moderate' ? 'üü°' : 'üî¥'} ${learning.signal}
                                                            </span>
                                                            <span class="badge">${learning.nextMove}</span>
                                                            <span class="badge" style="background: var(--bg-secondary);">
                                                                Follow-up: ${new Date(learning.followUpDate).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div style="font-size: 0.9rem; color: var(--text-secondary); line-height: 1.6;">
                                                    ${learning.takeaway.substring(0, 200)}${learning.takeaway.length > 200 ? '...' : ''}
                                                </div>
                                                ${learning.weeklyInsight ? `
                                                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(45, 80, 22, 0.05); border-left: 3px solid var(--core-green); border-radius: 4px;">
                                                        <strong style="font-size: 0.85rem; color: var(--core-green);">üí° Weekly Insight:</strong>
                                                        <div style="font-size: 0.85rem; color: var(--text-primary); margin-top: 0.25rem;">${learning.weeklyInsight}</div>
                                                    </div>
                                                ` : ''}
                                                <div style="margin-top: 0.75rem; text-align: right;">
                                                    <span style="font-size: 0.85rem; color: var(--core-green);">Click to edit ‚Üí</span>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn" onclick="app.closeWeekLearningsModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            },
            
            closeWeekLearningsModal() {
                const modal = document.getElementById('weekLearningsModal');
                if (modal) modal.remove();
            },

            // REPLACE openLearningModal() and add new openLearningModalForCompany()
            openLearningModalForCompany(companyName, weekStart) {
                // Check if learning already exists
                const existingLearning = this.learnings.find(l => 
                    l.company === companyName && l.weekStart === weekStart
                );
            
                if (existingLearning) {
                    this.loadLearningForEdit(existingLearning);
                } else {
                    // New learning
                    document.getElementById('learningForm').reset();
                    document.getElementById('learningId').value = '';
                    document.getElementById('learningWeekStart').value = weekStart;
                    document.getElementById('learningCompany').value = companyName;
                    
                    // Reset to simple mode
                    document.getElementById('simpleModeFields').classList.remove('hidden');
                    document.getElementById('deepDiveModeFields').classList.add('hidden');
                    
                    const weekStartDate = new Date(weekStart);
                    const weekEndDate = new Date(weekStart);
                    weekEndDate.setDate(weekEndDate.getDate() + 4);
                    document.getElementById('learningWeekLabel').textContent = 
                        `${weekStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            
                    this.loadCompanyActivityForLearning(companyName, weekStart);
                }
            
                this.openModal('learningModal');
            },

            // REPLACE loadCompanyDataForLearning()
            loadCompanyActivityForLearning(companyName, weekStart) {
                document.getElementById('learningCompanyName').textContent = companyName;
                
                const weekStartDate = new Date(weekStart);
                const weekEndDate = new Date(weekStart);
                weekEndDate.setDate(weekEndDate.getDate() + 5);
            
                // Get all people from this company with activity this week
                const companyContacts = this.contacts.filter(c => c.company === companyName);
                const peopleWithActivity = [];
            
                companyContacts.forEach(contact => {
                    if (!contact.communicationLog) return;
                    
                    const weekActivity = contact.communicationLog.filter(log => {
                        const logDate = new Date(log.date);
                        return logDate >= weekStartDate && logDate < weekEndDate;
                    });
                    
                    if (weekActivity.length > 0) {
                        peopleWithActivity.push({
                            name: contact.name,
                            contactId: contact.id,
                            tier: contact.tier,
                            activityCount: weekActivity.length,
                            latestChannel: weekActivity.sort((a, b) => new Date(b.date) - new Date(a.date))[0].channel,
                            latestDate: new Date(weekActivity.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date)
                        });
                    }
                });
            
                // Display simple activity summary
                if (peopleWithActivity.length > 0) {
                    document.getElementById('weekActivitySimple').innerHTML = peopleWithActivity.map(person => `
                        <div style="margin-bottom: 0.5rem;">
                            ‚Ä¢ ${person.name} <span class="badge" style="font-size: 0.75rem;">${person.tier}</span> - ${person.latestChannel}, ${person.latestDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
                        </div>
                    `).join('');
                } else {
                    document.getElementById('weekActivitySimple').innerHTML = '<em>No communications this week</em>';
                }
            
                // Render person assessment forms
                this.renderPersonAssessments(peopleWithActivity);
            },
            
            renderPersonAssessments(people) {
                const container = document.getElementById('personAssessments');
                
                if (people.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">No people to assess this week</p>';
                    return;
                }
            
                container.innerHTML = people.map((person, idx) => `
                    <div class="communication-entry-card" style="margin-bottom: 1rem;">
                        <h4 style="margin-bottom: 1rem;">${person.name} <span class="badge" style="font-size: 0.8rem;">${person.tier}</span></h4>
                        
                        <div class="form-group">
                            <label>Signal Strength for ${person.name}</label>
                            <div style="display: flex; gap: 2rem; margin-top: 0.5rem;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="signal-${idx}" value="Strong" required>
                                    <span>üü¢ Strong</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="signal-${idx}" value="Moderate" required>
                                    <span>üü° Moderate</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="signal-${idx}" value="Weak" required>
                                    <span>üî¥ Weak</span>
                                </label>
                            </div>
                        </div>
            
                        <div class="form-group">
                            <label>Next Move for ${person.name}</label>
                            <div style="display: flex; gap: 2rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="move-${idx}" value="Keep pushing" required>
                                    <span>Keep pushing</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="move-${idx}" value="Reroute" required>
                                    <span>Reroute</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="move-${idx}" value="Wait" required>
                                    <span>Wait</span>
                                </label>
                                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                    <input type="radio" name="move-${idx}" value="Drop it" required>
                                    <span>Drop it</span>
                                </label>
                            </div>
                        </div>
            
                        <div class="form-group">
                            <label>Follow-up Date for ${person.name}</label>
                            <input type="date" id="followUpDate-${idx}" required>
                        </div>
            
                        <input type="hidden" id="personContactId-${idx}" value="${person.contactId}">
                        <input type="hidden" id="personName-${idx}" value="${person.name}">
                    </div>
                `).join('');
            },

            
            // REPLACE loadLearningForEdit()
            loadLearningForEdit(learning) {
                document.getElementById('learningId').value = learning.id;
                document.getElementById('learningWeekStart').value = learning.weekStart;
                document.getElementById('learningCompany').value = learning.company;
                
                const weekStartDate = new Date(learning.weekStart);
                const weekEndDate = new Date(learning.weekStart);
                weekEndDate.setDate(weekEndDate.getDate() + 4);
                document.getElementById('learningWeekLabel').textContent = 
                    `${weekStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEndDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            
                this.loadCompanyActivityForLearning(learning.company, learning.weekStart);
                
                // Load company-level takeaway
                document.getElementById('learningTakeaway').value = learning.takeaway || '';
                
                // Load per-person assessments
                if (learning.personAssessments && learning.personAssessments.length > 0) {
                    setTimeout(() => {
                        learning.personAssessments.forEach((assessment, idx) => {
                            // Find the matching index in rendered cards
                            const signalRadio = document.querySelector(`input[name="signal-${idx}"][value="${assessment.signal}"]`);
                            if (signalRadio) signalRadio.checked = true;
                            
                            const moveRadio = document.querySelector(`input[name="move-${idx}"][value="${assessment.nextMove}"]`);
                            if (moveRadio) moveRadio.checked = true;
                            
                            const followUpInput = document.getElementById(`followUpDate-${idx}`);
                            if (followUpInput) followUpInput.value = assessment.followUpDate;
                        });
                    }, 100);
                }
                
                // Load deep dive if exists
                if (learning.deepDive) {
                    document.getElementById('learningThesis').value = learning.deepDive.strategicThesis || '';
                    document.getElementById('learningPL').value = learning.deepDive.plOwnership || '';
                    document.getElementById('learningInnovation').value = learning.deepDive.innovationOwnership || '';
                    document.getElementById('learningDecisions').value = learning.deepDive.decisionMaking || '';
                    document.getElementById('learningEvidence').value = learning.deepDive.evidence || '';
                    document.getElementById('learningPositioning').value = learning.deepDive.positioningInsight || '';
                }
                
                // Start in simple mode
                document.getElementById('deepDiveModeFields').classList.add('hidden');
            },

            // REPLACE saveLearning()
            saveLearning() {
                const companyName = document.getElementById('learningCompany').value;
                const weekStart = document.getElementById('learningWeekStart').value;
                const takeaway = document.getElementById('learningTakeaway').value;
                
                if (!companyName || !takeaway) {
                    alert('Please fill in the company takeaway');
                    return;
                }
            
                // Collect per-person assessments
                const personAssessments = [];
                const assessmentCards = document.querySelectorAll('#personAssessments .communication-entry-card');
                
                assessmentCards.forEach((card, idx) => {
                    const contactId = document.getElementById(`personContactId-${idx}`).value;
                    const personName = document.getElementById(`personName-${idx}`).value;
                    const signal = document.querySelector(`input[name="signal-${idx}"]:checked`);
                    const nextMove = document.querySelector(`input[name="move-${idx}"]:checked`);
                    const followUpDate = document.getElementById(`followUpDate-${idx}`).value;
                    
                    if (!signal || !nextMove || !followUpDate) {
                        alert(`Please complete all fields for ${personName}`);
                        throw new Error('Incomplete assessment');
                    }
                    
                    personAssessments.push({
                        contactId: contactId,
                        name: personName,
                        signal: signal.value,
                        nextMove: nextMove.value,
                        followUpDate: followUpDate
                    });
                });
            
                if (personAssessments.length === 0) {
                    alert('Please assess at least one person');
                    return;
                }
            
                const learningData = {
                    company: companyName,
                    weekStart: weekStart,
                    takeaway: takeaway,
                    personAssessments: personAssessments, // New structure
                    createdAt: new Date().toISOString()
                };
            
                // Check if deep dive mode was used
                const deepDiveVisible = !document.getElementById('deepDiveModeFields').classList.contains('hidden');
                if (deepDiveVisible) {
                    learningData.deepDive = {
                        strategicThesis: document.getElementById('learningThesis').value,
                        plOwnership: document.getElementById('learningPL').value,
                        innovationOwnership: document.getElementById('learningInnovation').value,
                        decisionMaking: document.getElementById('learningDecisions').value,
                        evidence: document.getElementById('learningEvidence').value,
                        positioningInsight: document.getElementById('learningPositioning').value
                    };
                }
            
                const existingId = document.getElementById('learningId').value;
                
                if (existingId) {
                    const index = this.learnings.findIndex(l => l.id === existingId);
                    this.learnings[index] = { ...this.learnings[index], ...learningData };
                } else {
                    learningData.id = generateUUID();
                    this.learnings.push(learningData);
                }
            
                // Update each contact's nextActionDate based on their follow-up date
                personAssessments.forEach(assessment => {
                    const contact = this.contacts.find(c => c.id === assessment.contactId);
                    if (contact) {
                        contact.nextActionDate = assessment.followUpDate;
                    }
                });
            
                this.saveData();
                this.renderLearnings();
                this.renderCalendar(); // Refresh calendar with new follow-up dates
                this.closeModal('learningModal');
                alert('‚úÖ Learning saved! Follow-up dates added to calendar.');
            },

            viewLearningDetail(learningId) {
                const learning = this.learnings.find(l => l.id === learningId);
                if (!learning) return;

                this.loadLearningForEdit(learning);
                this.openModal('learningModal');
            },

            // ADD these new functions after viewLearningDetail()

            showPastWeeksSelector() {
                // Generate list of past 12 weeks
                const weeks = [];
                for (let i = 1; i <= 12; i++) {
                    const weekDate = new Date();
                    weekDate.setDate(weekDate.getDate() - (i * 7));
                    const weekStart = this.getWeekStart(weekDate);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 4);
                    
                    const weekLabel = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                    
                    weeks.push({
                        weekStart: weekStart.toISOString().split('T')[0],
                        label: weekLabel
                    });
                }
                
                // Create modal content
                const modalHTML = `
                    <div class="modal active" id="pastWeeksModal" style="z-index: 1001;">
                        <div class="modal-content" style="max-width: 600px;">
                            <div class="modal-header">
                                <h2>Select a Past Week</h2>
                            </div>
                            <div class="modal-body">
                                <div style="display: grid; gap: 0.75rem;">
                                    ${weeks.map(week => {
                                        const learningsInWeek = this.learnings.filter(l => l.weekStart === week.weekStart);
                                        const companiesInWeek = this.getCompaniesInWeek(week.weekStart);
                                        
                                        return `
                                            <div class="chart-card" style="cursor: pointer; padding: 1.25rem; margin: 0;" 
                                                 onclick="app.viewPastWeek('${week.weekStart}')">
                                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                                    <div>
                                                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${week.label}</div>
                                                        <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                                            ${companiesInWeek.length} companies ‚Ä¢ ${learningsInWeek.length} learning${learningsInWeek.length !== 1 ? 's' : ''} logged
                                                        </div>
                                                    </div>
                                                    <div>
                                                        ${learningsInWeek.length === companiesInWeek.length ? '‚úÖ' : 
                                                          learningsInWeek.length > 0 ? 'üü°' : '‚è≥'}
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button class="btn" onclick="app.closePastWeeksModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add to body
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            },
            
            getCompaniesInWeek(weekStartStr) {
                const weekStart = new Date(weekStartStr);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 5); // Monday to Friday
                
                const companiesMap = {};
                
                this.contacts.forEach(contact => {
                    if (!contact.communicationLog) return;
                    
                    const weekActivity = contact.communicationLog.filter(log => {
                        const logDate = new Date(log.date);
                        return logDate >= weekStart && logDate < weekEnd;
                    });
                    
                    if (weekActivity.length > 0) {
                        if (!companiesMap[contact.company]) {
                            companiesMap[contact.company] = {
                                company: contact.company,
                                people: []
                            };
                        }
                        
                        companiesMap[contact.company].people.push({
                            name: contact.name,
                            tier: contact.tier,
                            activity: weekActivity,
                            contactId: contact.id
                        });
                    }
                });
                
                return Object.values(companiesMap);
            },
            
            viewPastWeek(weekStartStr) {
                this.closePastWeeksModal();
                
                const weekStart = new Date(weekStartStr);
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekEnd.getDate() + 4); // For display: Mon to Fri
                
                const companies = this.getCompaniesInWeek(weekStartStr);
                const learningsThisWeek = this.learnings.filter(l => l.weekStart === weekStartStr);
                
                const weekLabel = `${weekStart.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                
                // Create modal for past week view
                const modalHTML = `
                    <div class="modal active" id="pastWeekViewModal" style="z-index: 1001;">
                        <div class="modal-content" style="max-width: 900px;">
                            <div class="modal-header">
                                <h2>Week of ${weekLabel}</h2>
                                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 0.5rem;">
                                    ${companies.reduce((sum, c) => sum + c.people.length, 0)} people from ${companies.length} companies ‚Ä¢ 
                                    ${learningsThisWeek.length} learning${learningsThisWeek.length !== 1 ? 's' : ''} logged
                                </p>
                            </div>
                            <div class="modal-body" style="max-height: 60vh; overflow-y: auto;">
                                ${companies.length === 0 ? `
                                    <div class="empty-state">
                                        <p>No activity this week</p>
                                    </div>
                                ` : `
                                    <div style="display: grid; gap: 1rem;">
                                        ${companies.map(companyData => {
                                            const hasLearning = learningsThisWeek.find(l => l.company === companyData.company);
                                            const sortedPeople = companyData.people.sort((a, b) => 
                                                b.activity.length - a.activity.length
                                            );
                                            const topPeople = sortedPeople.slice(0, 3);
                                            const remainingCount = sortedPeople.length - 3;
            
                                            return `
                                                <div style="padding: 1.5rem; background: var(--bg-primary); border-radius: 8px; border-left: 4px solid ${hasLearning ? 'var(--core-green)' : 'var(--priority-medium)'};">
                                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                                        <div style="flex: 1;">
                                                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                                                <span style="font-size: 1.3rem;">${hasLearning ? '‚úÖ' : '‚è≥'}</span>
                                                                <h4 style="font-size: 1.2rem; font-weight: 600; margin: 0;">${companyData.company}</h4>
                                                            </div>
                                                            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
                                                                Spoke with: <strong>${companyData.people.length} person${companyData.people.length !== 1 ? 's' : ''}</strong>
                                                            </div>
                                                            
                                                            <div style="margin-left: 1rem; font-size: 0.9rem; line-height: 1.8;">
                                                                ${topPeople.map(person => {
                                                                    const latestActivity = person.activity.sort((a, b) => 
                                                                        new Date(b.date) - new Date(a.date)
                                                                    )[0];
                                                                    const activityDate = new Date(latestActivity.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                                                                    return `
                                                                        <div>‚Ä¢ ${person.name} <span class="badge" style="font-size: 0.75rem;">${person.tier}</span> - ${latestActivity.channel}, ${activityDate}</div>
                                                                    `;
                                                                }).join('')}
                                                                ${remainingCount > 0 ? `
                                                                    <div style="color: var(--text-secondary); font-style: italic; margin-top: 0.25rem;">
                                                                        (+ ${remainingCount} more)
                                                                    </div>
                                                                ` : ''}
                                                            </div>
                                                        </div>
                                                        <button class="btn" onclick="app.openLearningModalForCompany('${companyData.company}', '${weekStartStr}')" style="font-size: 0.85rem; flex-shrink: 0;">
                                                            ${hasLearning ? 'üìñ View' : 'üìù Log Learning'}
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `}
                            </div>
                            <div class="modal-footer">
                                <button class="btn" onclick="app.closePastWeekViewModal()">Close</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            },
            
            closePastWeeksModal() {
                const modal = document.getElementById('pastWeeksModal');
                if (modal) {
                    modal.remove();
                }
            },
            
            closePastWeekViewModal() {
                const modal = document.getElementById('pastWeekViewModal');
                if (modal) {
                    modal.remove();
                }
            },

            openModal(modalId) {
                document.getElementById(modalId).classList.add('active');
            },

            closeModal(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('active');
                }
                
                // Also close any dynamically created modals
                this.closePastWeeksModal();
                this.closePastWeekViewModal();
            },
        };

        // Initialize app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>
