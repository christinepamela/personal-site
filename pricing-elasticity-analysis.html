<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Elasticity Analysis</title>
    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <!-- Papa Parse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { margin-top: 30px; }
        .results-section { margin-top: 20px; }
        .error { color: red; }
        .chart-container { 
            height: 400px;
            position: relative;
        }
        .data-table { 
            max-height: 400px; 
            overflow-y: auto; 
        }
        .summary-stats { 
            font-size: 1.1em; 
            font-weight: bold; 
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h1 class="mb-4">Equipment Elasticity Analysis</h1>
        
        <!-- File Upload Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Upload Data</h5>
                <div class="mb-3">
                    <input type="file" 
                           class="form-control" 
                           @change="handleFileSelection" 
                           accept=".csv,.xlsx,.xls"
                           ref="fileInput">
                    <small class="text-muted">Select CSV or Excel file</small>
                    <div class="mt-2">
                        <button class="btn btn-primary" @click="uploadSelectedFile" :disabled="!selectedFile">
                            Upload File
                        </button>
                        <button class="btn btn-danger ms-2" @click="clearAnalysis" v-if="results">
                            Clear Analysis
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sample Template Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Sample Template</h5>
                <p>Download a sample template to see the required format:</p>
                <button class="btn btn-secondary" @click="downloadTemplate">
                    Download Template
                </button>
                <button class="btn btn-info ms-2" @click="loadSampleData">
                    Load Sample Data
                </button>
            </div>
        </div>

        <!-- Data Requirements -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Required Fields</h5>
                <ul>
                    <li>Asset ID</li>
                    <li>Make/Model</li>
                    <li>Customer</li>
                    <li>Prior Year Price</li>
                    <li>Renewal Price</li>
                    <li>% Price Change</li>
                    <li>Renewal Outcome</li>
                    <li>Reason Code</li>
                </ul>
                <p class="text-muted">Optional: Environment, Equipment Type, Customer Segment</p>
            </div>
        </div>

        <!-- Results Section -->
        <div v-if="results" class="results-section">
            <!-- Summary Statistics -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Summary Statistics</h5>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="summary-stats">
                                Total Assets: {{ results.summary.totalAssets }}
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-stats">
                                Overall Renewal Rate: {{ (results.summary.overallRenewalRate * 100).toFixed(1) }}%
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-stats">
                                Avg Price Change: {{ results.summary.avgPriceChange.toFixed(1) }}%
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="summary-stats">
                                Price Elasticity: {{ results.summary.priceElasticity.toFixed(2) }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Price Band Analysis -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Price Band Analysis</h5>
                    <div class="data-table">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Price Band</th>
                                    <th>Count</th>
                                    <th>Renewal Rate</th>
                                    <th>Avg Price Change</th>
                                    <th>Revenue Impact</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(band, index) in results.priceBands" :key="index">
                                    <td>{{ band.range }}</td>
                                    <td>{{ band.count }}</td>
                                    <td>{{ (band.renewalRate * 100).toFixed(1) }}%</td>
                                    <td>{{ band.avgPriceChange.toFixed(1) }}%</td>
                                    <td>{{ formatCurrency(band.revenueImpact) }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Elasticity Chart -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Elasticity Curve</h5>
                    <div class="chart-container">
                        <canvas id="elasticityChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Segment Analysis -->
            <div v-if="results.segments" class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Segment Analysis</h5>
                    <div class="accordion" id="segmentAccordion">
                        <div class="accordion-item" v-for="(segment, key) in results.segments" :key="key">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" 
                                        :data-bs-target="'#segment' + key.replace(/\s+/g, '')"
                                        data-bs-toggle="collapse">
                                    {{ key }}
                                </button>
                            </h2>
                            <div :id="'segment' + key.replace(/\s+/g, '')" class="accordion-collapse collapse">
                                <div class="accordion-body">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Segment Value</th>
                                                <th>Count</th>
                                                <th>Renewal Rate</th>
                                                <th>Avg Price Change</th>
                                                <th>Elasticity</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="(data, value) in segment" :key="value">
                                                <td>{{ value }}</td>
                                                <td>{{ data.count }}</td>
                                                <td>{{ (data.renewalRate * 100).toFixed(1) }}%</td>
                                                <td>{{ data.avgPriceChange.toFixed(1) }}%</td>
                                                <td>{{ data.elasticity.toFixed(2) }}</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Download Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Download Results</h5>
                    <button class="btn btn-primary" @click="downloadResults">
                        Download Analysis Results
                    </button>
                    <button class="btn btn-secondary ms-2" @click="downloadCleanedData">
                        Download Cleaned Dataset
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div v-if="error" class="alert alert-danger" role="alert">
            {{ error }}
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        new Vue({
            el: '#app',
            data: {
                results: null,
                error: null,
                chart: null,
                rawData: null,
                selectedFile: null,
                sampleData: [
                    {
                        'Asset ID': 'A001',
                        'Make/Model': 'Server X1',
                        'Customer': 'Enterprise Co',
                        'Prior Year Price': 10000,
                        'Renewal Price': 11000,
                        '% Price Change': 10,
                        'Renewal Outcome': 'Renewed',
                        'Reason Code': 'Standard',
                        'Environment': 'Production',
                        'Equipment Type': 'Server',
                        'Customer Segment': 'Enterprise'
                    }
                ]
            },
            methods: {
                handleFileSelection(event) {
                    this.selectedFile = event.target.files[0];
                    this.clearAnalysis();
                },

                clearAnalysis() {
                    this.results = null;
                    this.error = null;
                    this.rawData = null;
                    if (this.chart) {
                        this.chart.destroy();
                        this.chart = null;
                    }
                },

                uploadSelectedFile() {
                    if (!this.selectedFile) return;
                    
                    if (this.selectedFile.type === 'text/csv') {
                        this.parseCSV(this.selectedFile);
                    } else if (this.selectedFile.type === 'application/vnd.ms-excel' || 
                             this.selectedFile.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
                        this.parseExcel(this.selectedFile);
                    } else {
                        this.error = 'Please upload a CSV or Excel file';
                    }
                },

                parseCSV(file) {
                    Papa.parse(file, {
                        complete: (results) => {
                            console.log('CSV Parse Results:', results);
                            this.processData(results.data);
                        },
                        header: true,
                        skipEmptyLines: true
                    });
                },

                parseExcel(file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = e.target.result;
                            const workbook = XLSX.read(data, { type: 'binary' });
                            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                            const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                            console.log('Excel Parse Results:', jsonData);
                            this.processData(jsonData);
                        } catch (error) {
                            this.error = 'Error processing Excel file: ' + error.message;
                        }
                    };
                    reader.readAsBinaryString(file);
                },

                processData(data) {
                    try {
                        console.log('Processing data:', data);
                        if (!data || data.length === 0) {
                            this.error = 'No data found in file';
                            return;
                        }

                        this.rawData = data;
                
                        // Validate required columns
                        const requiredColumns = [
                            'Asset ID', 'Make/Model', 'Customer',
                            'Prior Year Price', 'Renewal Price',
                            '% Price Change', 'Renewal Outcome'
                        ];
                
                        const headers = Object.keys(data[0]);
                        console.log('Headers found:', headers);
                
                        const missingColumns = requiredColumns.filter(
                            col => !headers.includes(col)
                        );
                
                        if (missingColumns.length > 0) {
                            this.error = `Missing required columns: ${missingColumns.join(', ')}`;
                            return;
                        }
                
                        // Calculate summary statistics
                        const summary = this.calculateSummary(data);
                        
                        // Process price bands
                        const priceBands = this.analyzePriceBands(data);
                        
                        // Process segments if available
                        const segments = this.analyzeSegments(data);
                
                        // Set results first
                        this.results = {
                            summary,
                            priceBands,
                            segments
                        };
                        
                        // Wait for the next tick before updating the chart
                        this.$nextTick(() => {
                            this.updateChart();
                        });
                        
                        this.error = null;
                
                    } catch (err) {
                        console.error('Error in processData:', err);
                        this.error = `Error processing data: ${err.message}`;
                    }
                },

                calculateSummary(data) {
                    const totalAssets = data.length;
                    const renewed = data.filter(row => 
                        String(row['Renewal Outcome']).toLowerCase() === 'renewed'
                    ).length;
                    const overallRenewalRate = renewed / totalAssets;
                    const avgPriceChange = data.reduce((acc, row) => 
                        acc + parseFloat(row['% Price Change']), 0) / totalAssets;
                    
                    // Calculate price elasticity
                    const priceElasticity = (1 - overallRenewalRate) / (avgPriceChange / 100);

                    return {
                        totalAssets,
                        overallRenewalRate,
                        avgPriceChange,
                        priceElasticity
                    };
                },

                analyzePriceBands(data) {
                    const bands = [
                        { min: 0, max: 5 },
                        { min: 5, max: 10 },
                        { min: 10, max: 20 },
                        { min: 20, max: Infinity }
                    ];

                    return bands.map(band => {
                        const filtered = data.filter(row => {
                            const priceChange = parseFloat(row['% Price Change']);
                            return priceChange >= band.min && priceChange < band.max;
                        });

                        const renewed = filtered.filter(
                            row => String(row['Renewal Outcome']).toLowerCase() === 'renewed'
                        ).length;

                        const revenueImpact = filtered.reduce((acc, row) => {
                            const priceChange = parseFloat(row['Renewal Price']) - 
                                             parseFloat(row['Prior Year Price']);
                            return acc + (String(row['Renewal Outcome']).toLowerCase() === 'renewed' ? 
                                   priceChange : -parseFloat(row['Prior Year Price']));
                        }, 0);

                        return {
                            range: `${band.min}%-${band.max === Infinity ? '∞' : band.max}%`,
                            count: filtered.length,
                            renewalRate: filtered.length ? renewed / filtered.length : 0,
                            avgPriceChange: filtered.length ? 
                                filtered.reduce((acc, row) => acc + parseFloat(row['% Price Change']), 0) / filtered.length : 0,
                            revenueImpact
                        };
                    });
                },

                analyzeSegments(data) {
                    const segmentColumns = ['Environment', 'Equipment Type', 'Customer Segment']
                        .filter(col => Object.keys(data[0]).includes(col));

                    if (segmentColumns.length === 0) return null;

                    const segments = {};
                    
                    segmentColumns.forEach(segmentCol => {
                        segments[segmentCol] = {};
                        
                        // Get unique segment values
                        const segmentValues = [...new Set(data.map(row => row[segmentCol]))];
                        
                        segmentValues.forEach(value => {
                            const segmentData = data.filter(row => row[segmentCol] === value);
                            const renewed = segmentData.filter(
                                row => String(row['Renewal Outcome']).toLowerCase() === 'renewed'
                            ).length;
                            
                            segments[segmentCol][value] = {
                                count: segmentData.length,
                                renewalRate: renewed / segmentData.length,
                                avgPriceChange: segmentData.reduce((acc, row) => 
                                    acc + parseFloat(row['% Price Change']), 0) / segmentData.length,
                                elasticity: (1 - (renewed / segmentData.length)) / 
                                    (segmentData.reduce((acc, row) => 
                                        acc + parseFloat(row['% Price Change']), 0) / segmentData.length / 100)
                            };
                        });
                    });

                    return segments;
                },

                updateChart() {
                    this.$nextTick(() => {
                        try {
                            const canvas = document.getElementById('elasticityChart');
                            if (!canvas) {
                                console.error('Canvas element not found');
                                return;
                            }

                            if (this.chart) {
                                this.chart.destroy();
                            }

                            const ctx = canvas.getContext('2d');
                            if (!ctx) {
                                console.error('Could not get canvas context');
                                return;
                            }

                            this.chart = new Chart(ctx, {
                                type: 'line',
                                data: {
                                    labels: this.results.priceBands.map(band => band.range),
                                    datasets: [{
                                        label: 'Renewal Rate',
                                        data: this.results.priceBands.map(band => band.renewalRate * 100),
                                        borderColor: 'rgb(75, 192, 192)',
                                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                        tension: 0.1,
                                        fill: true
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            title: {
                                                display: true,
                                                text: 'Renewal Rate (%)'
                                            }
                                        },
                                        x: {
                                            title: {
                                                display: true,
                                                text: 'Price Change Band'
                                            }
                                        }
                                    },
                                    plugins: {
                                        title: {
                                            display: true,
                                            text: 'Price Elasticity Curve'
                                        }
                                    }
                                }
                            });
                        } catch (err) {
                            console.error('Error creating chart:', err);
                            this.error = 'Error creating chart: ' + err.message;
                        }
                    });
                },

                downloadResults() {
                    const summaryData = [
                        ['Summary Statistics'],
                        ['Total Assets', this.results.summary.totalAssets],
                        ['Overall Renewal Rate', (this.results.summary.overallRenewalRate * 100).toFixed(1) + '%'],
                        ['Average Price Change', this.results.summary.avgPriceChange.toFixed(1) + '%'],
                        ['Price Elasticity', this.results.summary.priceElasticity.toFixed(2)],
                        [],
                        ['Price Band Analysis'],
                        ['Band', 'Count', 'Renewal Rate', 'Avg Price Change', 'Revenue Impact']
                    ];

                    this.results.priceBands.forEach(band => {
                        summaryData.push([
                            band.range,
                            band.count,
                            (band.renewalRate * 100).toFixed(1) + '%',
                            band.avgPriceChange.toFixed(1) + '%',
                            this.formatCurrency(band.revenueImpact)
                        ]);
                    });

                    if (this.results.segments) {
                        Object.entries(this.results.segments).forEach(([segmentType, segmentData]) => {
                            summaryData.push(
                                [],
                                [`${segmentType} Analysis`],
                                ['Segment', 'Count', 'Renewal Rate', 'Avg Price Change', 'Elasticity']
                            );

                            Object.entries(segmentData).forEach(([value, data]) => {
                                summaryData.push([
                                    value,
                                    data.count,
                                    (data.renewalRate * 100).toFixed(1) + '%',
                                    data.avgPriceChange.toFixed(1) + '%',
                                    data.elasticity.toFixed(2)
                                ]);
                            });
                        });
                    }

                    const csv = Papa.unparse(summaryData);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', '');
                    a.setAttribute('href', url);
                    a.setAttribute('download', 'elasticity_analysis_results.csv');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },

                downloadCleanedData() {
                    if (!this.rawData) return;
                    
                    const csv = Papa.unparse(this.rawData);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', '');
                    a.setAttribute('href', url);
                    a.setAttribute('download', 'cleaned_data.csv');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },

                downloadTemplate() {
                    const templateData = [
                        {
                            'Asset ID': 'A001',
                            'Make/Model': 'Sample Equipment',
                            'Customer': 'Customer 1',
                            'Prior Year Price': 1000,
                            'Renewal Price': 1100,
                            '% Price Change': 10,
                            'Renewal Outcome': 'Renewed',
                            'Reason Code': 'Standard',
                            'Environment': 'Production',
                            'Equipment Type': 'Type A',
                            'Customer Segment': 'Enterprise'
                        }
                    ];
                    
                    const csv = Papa.unparse(templateData);
                    const blob = new Blob([csv], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', '');
                    a.setAttribute('href', url);
                    a.setAttribute('download', 'equipment_elasticity_template.csv');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },

                loadSampleData() {
                    this.processData(this.sampleData);
                },

                formatCurrency(value) {
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD'
                    }).format(value);
                }
            }
        });
    </script>
</body>
</html>
