<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Equipment Elasticity Analysis</title>
    <!-- Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14"></script>
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Papa Parse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <!-- Bootstrap for styling -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { margin-top: 30px; }
        .results-section { margin-top: 20px; }
        .error { color: red; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <h1 class="mb-4">Equipment Elasticity Analysis</h1>
        
        <!-- File Upload Section -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Upload Data</h5>
                <div class="mb-3">
                    <input type="file" 
                           class="form-control" 
                           @change="handleFileUpload" 
                           accept=".csv,.xlsx">
                    <small class="text-muted">Upload CSV or Excel file</small>
                </div>
            </div>
        </div>

        <!-- Data Requirements -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title">Required Fields</h5>
                <ul>
                    <li>Asset ID</li>
                    <li>Make/Model</li>
                    <li>Customer</li>
                    <li>Prior Year Price</li>
                    <li>Renewal Price</li>
                    <li>% Price Change</li>
                    <li>Renewal Outcome</li>
                    <li>Reason Code</li>
                </ul>
                <p class="text-muted">Optional: Environment, Equipment Type, Customer Segment</p>
            </div>
        </div>

        <!-- Results Section -->
        <div v-if="results" class="results-section">
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Price Band Analysis</h5>
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Price Band</th>
                                <th>Count</th>
                                <th>Renewal Rate</th>
                                <th>Avg Price Change</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(band, index) in results.priceBands" :key="index">
                                <td>{{ band.range }}</td>
                                <td>{{ band.count }}</td>
                                <td>{{ (band.renewalRate * 100).toFixed(1) }}%</td>
                                <td>{{ band.avgPriceChange.toFixed(1) }}%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Elasticity Chart -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Elasticity Curve</h5>
                    <canvas id="elasticityChart"></canvas>
                </div>
            </div>

            <!-- Download Section -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">Download Results</h5>
                    <button class="btn btn-primary" @click="downloadResults">
                        Download Analysis Results
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Display -->
        <div v-if="error" class="alert alert-danger" role="alert">
            {{ error }}
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data: {
                results: null,
                error: null,
                chart: null
            },
            methods: {
                handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                // Add support for both CSV and Excel
                if (file.type === 'text/csv' || file.type === 'application/vnd.ms-excel' || 
                file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet') {
        
                if (file.type === 'text/csv') {
                this.parseCSV(file);
                } else {
            this.parseExcel(file);
            }
            } else {
            this.error = 'Please upload a CSV or Excel file';
            }
            },

                parseCSV(file) {
                    Papa.parse(file, {
                        complete: (results) => {
                            this.processData(results.data);
                        },
                        header: true,
                        skipEmptyLines: true
                    });
                },

                processData(data) {
                    try {
                        // Validate required columns
                        const requiredColumns = [
                            'Asset ID', 'Make/Model', 'Customer',
                            'Prior Year Price', 'Renewal Price',
                            '% Price Change', 'Renewal Outcome'
                        ];

                        const headers = Object.keys(data[0]);
                        const missingColumns = requiredColumns.filter(
                            col => !headers.includes(col)
                        );

                        if (missingColumns.length > 0) {
                            this.error = `Missing required columns: ${missingColumns.join(', ')}`;
                            return;
                        }

                        // Process price bands
                        const priceBands = this.analyzePriceBands(data);
                        
                        // Calculate elasticity
                        const elasticity = this.calculateElasticity(data);

                        this.results = {
                            priceBands,
                            elasticity
                        };

                        this.updateChart();
                        this.error = null;

                    } catch (err) {
                        this.error = `Error processing data: ${err.message}`;
                    }
                },

                analyzePriceBands(data) {
                    const bands = [
                        { min: 0, max: 5 },
                        { min: 5, max: 10 },
                        { min: 10, max: 20 },
                        { min: 20, max: Infinity }
                    ];

                    return bands.map(band => {
                        const filtered = data.filter(row => {
                            const priceChange = parseFloat(row['% Price Change']);
                            return priceChange >= band.min && priceChange < band.max;
                        });

                        const renewed = filtered.filter(
                            row => row['Renewal Outcome'].toLowerCase() === 'renewed'
                        ).length;

                        return {
                            range: `${band.min}%-${band.max === Infinity ? 'âˆž' : band.max}%`,
                            count: filtered.length,
                            renewalRate: filtered.length ? renewed / filtered.length : 0,
                            avgPriceChange: filtered.length ? 
                                filtered.reduce((acc, row) => acc + parseFloat(row['% Price Change']), 0) / filtered.length : 0
                        };
                    });
                },

                calculateElasticity(data) {
                    // Simple elasticity calculation
                    const priceChanges = data.map(row => parseFloat(row['% Price Change']));
                    const renewalRates = data.map(row => row['Renewal Outcome'].toLowerCase() === 'renewed' ? 1 : 0);

                    // Calculate average effect
                    const avgPriceChange = priceChanges.reduce((a, b) => a + b, 0) / priceChanges.length;
                    const avgRenewalRate = renewalRates.reduce((a, b) => a + b, 0) / renewalRates.length;

                    return {
                        avgPriceChange,
                        avgRenewalRate,
                        pointElasticity: (avgRenewalRate / avgPriceChange)
                    };
                },

                updateChart() {
                    if (this.chart) {
                        this.chart.destroy();
                    }

                    const ctx = document.getElementById('elasticityChart').getContext('2d');
                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: this.results.priceBands.map(band => band.range),
                            datasets: [{
                                label: 'Renewal Rate',
                                data: this.results.priceBands.map(band => band.renewalRate * 100),
                                borderColor: 'rgb(75, 192, 192)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Renewal Rate (%)'
                                    }
                                }
                            }
                        }
                    });
                },

                downloadResults() {
                    const csvContent = this.generateCSV();
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.setAttribute('hidden', '');
                    a.setAttribute('href', url);
                    a.setAttribute('download', 'elasticity_analysis_results.csv');
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                },

                generateCSV() {
                    const headers = ['Price Band', 'Count', 'Renewal Rate', 'Avg Price Change'];
                    const rows = this.results.priceBands.map(band => [
                        band.range,
                        band.count,
                        (band.renewalRate * 100).toFixed(1) + '%',
                        band.avgPriceChange.toFixed(1) + '%'
                    ]);

                    return [
                        headers.join(','),
                        ...rows.map(row => row.join(','))
                    ].join('\n');
                }
            }
        });
    </script>
</body>
</html>
